# ARR071P_P02 程式規格書

## 1. 基本資料

| 項目 | 內容 |
|------|------|
| **程式編號** | ARR071P |
| **程式名稱** | 收料未確認會計報表控制程式 |
| **程式類型** | CLP |
| **廠區** | P02 |
| **系統名稱** | 應收帳款系統 |
| **子系統** | 收料未確認報表系統 |
| **檔案位置** | P02CLSRC_THSRC/ARR071P.txt |

## 2. 🎯 程式功能說明

### 主要功能描述
此程式為收料未確認會計報表的控制程式，專門處理尚未確認收料的報表產生作業。程式查詢未確認狀態的收料資料，按照廠區分類產生未確認收料會計報表，支援日期截止範圍控制，提供管理者掌握待確認收料的完整資訊。

### 🎯 業務流程詳細說明

#### 完整業務流程圖
```mermaid
flowchart TD
    A[程式啟動] --> B[檢查執行環境]
    B --> C{執行模式判斷}
    C -->|互動式模式| D[取得系統資訊]
    C -->|批次模式| E[BATCH:批次處理]
    D --> F[從LDA取得公司和設備資訊]
    F --> G[取得當前系統日期]
    G --> H[設定預設收料日期]
    H --> I[INPUT:參數輸入迴圈]
    I --> J[顯示ARR071S輸入畫面]
    J --> K{檢查功能鍵}
    K -->|F3/F12| L[程式結束]
    K -->|Enter| M[參數驗證階段]
    M --> N[收料廠區必填檢核]
    N --> O{廠區是否空白}
    O -->|是| P[顯示錯誤訊息]
    P --> I
    O -->|否| Q[日期格式驗證]
    Q --> R[調用UTS102R驗證日期]
    R --> S{日期格式正確}
    S -->|否| T[顯示格式錯誤]
    T --> I
    S -->|是| U[參數儲存至LDA]
    U --> V[提交批次作業]
    V --> W[設定作業進度訊息]
    W --> L
    E --> X[從LDA讀取所有參數]
    X --> Y[收料廠區參數]
    Y --> Z[收料日期參數]
    Z --> AA[報表檔案設定]
    AA --> BB[檔案覆蓋設定]
    BB --> CC[建立SARCVF查詢]
    CC --> DD[未確認狀態篩選]
    DD --> EE[日期範圍篩選]
    EE --> FF[調用ARR071R報表程式]
    FF --> GG[關閉查詢]
    GG --> HH[清除覆蓋設定]
    HH --> II[程式結束]
```

#### 業務流程關鍵階段說明

**階段一：參數收集與驗證**
- 互動式畫面收集收料廠區和收料截止日期
- 雙層驗證機制：必填檢核和專業日期格式驗證
- 使用UTS102R進行日期格式檢核
- 不進行日期範圍邏輯檢核(已註解)

**階段二：多廠區支援處理**
- 支援P(台北)、M(台中)、T(臺南)、H(高雄)、K(嘉義)等五大廠區
- 廠區代碼嚴格限制在預設值清單內
- 各廠區獨立的未確認收料處理邏輯

**階段三：未確認收料資料篩選**
- 使用OPNQRYF對SARCVF進行特定條件查詢
- 核心篩選條件：SRFL01=' '(未確認)且SRFL02=' '(未會計處理)
- %SST函數進行收料編號首位廠區比對
- 日期範圍使用≤條件截止到指定日期

**階段四：報表產生與輸出**
- 設定ARR071T報表檔案格式(158字元寬度、12CPI)
- 調用ARR071R進行實際報表處理
- 自動清理檔案覆蓋和查詢資源

## 3. 🎯 檔案架構與關聯圖

### 使用檔案清單

| 檔案名稱 | 檔案類型 | 使用方式 | 說明 |
|----------|----------|----------|------|
| ARR071S | 畫面檔 | DCLF | 參數輸入畫面檔案 |
| ARR071R | 程式 | CALL | 報表處理程式 |
| UTS102R | 程式 | CALL | 日期格式驗證程式 |
| SARCVF | 實體檔 | INPUT | 收料檔案(主要資料來源) |
| SARVIN | 實體檔 | INPUT | 收料相關檔案 |
| ARR071T | 報表檔 | OUTPUT | 報表輸出檔案 |
| *LDA | 資料區 | I/O | 本機資料區(參數傳遞) |

### 🎯 檔案關聯詳細視覺化圖表

```mermaid
graph TD
    A[ARR071P控制程式] --> B[ARR071S參數輸入畫面]
    A --> C[*LDA本機資料區]
    A --> D[UTS102R日期驗證程式]
    A --> E[SARCVF收料檔案]
    A --> F[SARVIN收料相關檔案]
    A --> G[ARR071R報表程式]
    A --> H[ARR071T報表檔案]
    
    B --> |使用者輸入| I[廠區+截止日期]
    C --> |參數傳遞| J[批次作業參數]
    D --> |驗證結果| K[日期格式檢核]
    E --> |收料資料| L[未確認收料明細]
    F --> |關聯資料| M[收料輔助資訊]
    G --> |報表處理| N[未確認收料會計報表]
    H --> |報表輸出| O[格式化報表檔案]
    
    subgraph "參數驗證流程"
        P[必填檢核] --> Q[格式驗證]
        Q --> R[參數儲存]
    end
    
    subgraph "資料篩選流程"
        S[未確認狀態篩選] --> T[廠區篩選]
        T --> U[日期範圍篩選]
    end
```

### 🎯 資料流向詳細說明

#### 環境準備階段的資料流向
```mermaid
sequenceDiagram
    participant U as 使用者
    participant A as ARR071P
    participant S as ARR071S
    participant L as LDA
    participant D as UTS102R
    
    U->>A: 執行程式
    A->>A: RTVJOBA檢查執行模式
    A->>L: 取得公司和設備資訊
    A->>A: RTVJOBA取得系統日期
    A->>S: SNDRCVF顯示輸入畫面
    S->>U: 顯示參數輸入畫面
    U->>S: 輸入廠區和截止日期
    A->>A: 參數必填檢核
    A->>D: CALL日期格式驗證
    D->>A: 回傳驗證結果
    A->>L: 儲存參數至LDA
```

#### 業務處理階段的資料流向
```mermaid
sequenceDiagram
    participant A as ARR071P批次
    participant L as LDA
    participant S as SARCVF
    participant V as SARVIN
    participant R as ARR071R
    participant T as ARR071T
    
    A->>L: RTVDTAARA取得全部參數
    A->>T: OVRPRTF設定報表格式
    A->>V: OVRDBF設定檔案覆蓋
    A->>S: OVRDBF設定收料檔案
    A->>S: OPNQRYF建立未確認查詢
    A->>R: CALL報表處理程式
    R->>S: 讀取未確認收料資料
    R->>T: 產生格式化報表
    A->>S: CLOF關閉查詢
    A->>A: DLTOVR清除覆蓋設定
```

#### 報表產生階段的資料流向
```mermaid
sequenceDiagram
    participant A as ARR071P
    participant R as ARR071R
    participant S as SARCVF
    participant T as ARR071T
    participant U as 使用者
    
    A->>T: 設定報表格式(158字元、12CPI)
    A->>R: 調用報表處理程式
    R->>S: 依查詢條件讀取資料
    R->>R: 未確認收料資料分析
    R->>T: 寫入格式化報表行
    R->>T: 產生小計和合計
    T->>U: 輸出未確認收料報表
```

## 4. 🎯 檔案欄位規格說明

### 主要資料結構

#### 程式變數定義
| 變數名稱 | 型態 | 長度 | 用途說明 |
|----------|------|------|----------|
| &INT | *CHAR | 1 | 工作類型識別 |
| &OUTQ | *CHAR | 10 | 輸出佇列名稱 |
| &W#FLAG | *CHAR | 1 | 處理旗標 |
| &W#DATE | *DEC | 8,0 | 日期數值(YYYYMMDD) |
| &W#UDATE | *CHAR | 8 | 字串日期格式 |
| &W#RVDT | *CHAR | 8 | 收料截止日期 |
| &P#PDAT | *CHAR | 8 | 日期驗證輸入參數 |
| &P#MODE | *CHAR | 1 | 驗證模式參數 |
| &P#MTL | *CHAR | 24 | 月份資訊 |
| &P#LEAP | *CHAR | 1 | 閏年旗標 |

#### SARCVF收料檔案結構
| 欄位名稱 | 型態 | 長度 | 位置 | 說明 |
|----------|------|------|------|------|
| SRRVNO | A | 6 | 1-6 | 收料編號 |
| SRFL01 | A | 1 | 7 | 收料確認旗標 |
| SRFL02 | A | 1 | 8 | 會計處理旗標 |
| SRNAMT | P | 11,0 | 12-16 | 收料金額含稅 |
| SRXAMT | P | 11,0 | 17-21 | 沖銷發票金額含稅 |
| SRRVDT | S | 8,0 | 22-25 | 收料日期 |
| SRCUNO | A | 6 | 26-31 | 客戶編號 |
| SRDPNO | A | 4 | 32-35 | 部門編號 |
| SRRVID | A | 2 | 36-37 | 營收業務員 |
| SRITEM | S | 2,0 | 38-39 | 項次 |

#### ARR071S畫面檔案結構
| 欄位名稱 | 型態 | 長度 | 屬性 | 說明 |
|----------|------|------|------|------|
| S#COMP | A | 35 | O | 公司名稱(顯示) |
| S#DEVI | A | 10 | O | 設備名稱(顯示) |
| S#RVDP | A | 1 | B | 收料廠區(輸入) |
| S#RVDT | Y | 8,0 | B | 收料截止日期(輸入) |
| S#MSG1 | A | 70 | O | 錯誤訊息(顯示) |

### 🔍 重點欄位切割技術詳解

#### 本機資料區(LDA)欄位切割視覺化展示
```
LDA資料區 (1024字元)：[P|DDDDDDDD|...........................]
位置:                  1  2                                
                       ↓  ↓                                
RVDP (1字元)：        [P]                                  收料廠區
RVDT (8字元)：          [DDDDDDDD]                         收料截止日期
```

#### LDA參數配置詳細說明
- **位置1**：收料廠區代碼，限定值P/M/T/H/K
- **位置2-9**：收料截止日期，格式YYYYMMDD

#### OPNQRYF查詢條件欄位切割技術

**SARCVF未確認查詢條件實例**：
```104:110:東鋼list/ARR071P_P02.txt
OPNQRYF    FILE(SARCVF) +
           QRYSLT( +
            'SRFL02 *EQ " " *AND   +
             SRFL01 *EQ " " *AND   +
        %SST(SRRVNO 1 1) *EQ "' || &S#RVDP || '" *AND +
             SRRVDT *LE ' || &W#RVDT ) +
           KEYFLD((SRRVID) (SRRVDT) (SRRVNO))
```

### 🎯 欄位挪用詳細分析

#### 挪用情況對比表

| 欄位名稱 | 原始定義 | 實際使用方式 | 挪用類型 | 使用狀態 |
|----------|----------|-------------|----------|----------|
| **%SST(SRRVNO 1 1)** | 收料編號首位 | 收料廠區識別碼 | 位置性挪用 | 廠區比對邏輯 |
| **SRFL01收料確認旗標** | 確認狀態標記 | 未確認篩選條件 | 反向性挪用 | 空白值篩選 |
| **W#DATE日期變數** | 6位數日期格式 | 8位數日期格式 | 格式性挪用 | 9908A版本升級 |
| **SRRVDT日期比對** | 等值比對 | 範圍比對(≤) | 邏輯性挪用 | 截止日期控制 |

#### 挪用原因深度分析

**1. 收料編號首位廠區挪用(%SST(SRRVNO 1 1))**
- **原始設計目的**：SRRVNO為完整的6位數收料編號
- **實際挪用原因**：
  - 廠區識別需求：第一位字元代表收料所屬廠區
  - 查詢效率最佳化：只比對首位避免全欄位掃描
  - 業務邏輯需求：不同廠區的收料需要分別處理
- **業務邏輯影響**：實現廠區層級的收料資料篩選

**2. 收料確認旗標反向挪用(SRFL01=' ')**
- **原始設計目的**：SRFL01用於標示收料確認狀態('Y'=已確認)
- **實際挪用原因**：
  - 未確認狀態識別：空白值表示尚未確認收料
  - 業務流程控制：只處理待確認的收料資料
  - 報表功能區分：與ARR070P(已確認)形成對比
- **業務邏輯影響**：精確篩選出需要確認的收料項目

**3. 日期變數格式挪用(W#DATE)**
- **原始設計目的**：W#DATE原為6位數日期變數(YYMMDD)
- **實際挪用原因**：
  - Y2K問題解決：9908A版本升級為8位數(YYYYMMDD)
  - 向下相容性：保持原有邏輯結構
  - 精確度提升：完整年份資訊避免歧義
- **業務邏輯影響**：提升日期處理精確度和相容性

**4. 日期比對邏輯挪用(SRRVDT *LE)**
- **原始設計目的**：日期比對通常使用等值比較
- **實際挪用原因**：
  - 截止日期需求：查詢指定日期前的所有未確認收料
  - 彈性查詢邏輯：不限定特定日期而是範圍查詢
  - 管理需求：提供累積至某日期的未確認狀況
- **業務邏輯影響**：實現更靈活的日期範圍查詢

#### 挪用方式詳細說明

**收料編號首位挪用實現方式**：
```108:108:東鋼list/ARR071P_P02.txt
%SST(SRRVNO 1 1) *EQ "' || &S#RVDP || '" *AND +
```
- **切割技術**：使用%SST函數取收料編號第1位字元
- **比對邏輯**：與使用者輸入的廠區代碼精確比對
- **效能最佳化**：避免全欄位掃描提升查詢速度

**未確認狀態篩選實現方式**：
```106:107:東鋼list/ARR071P_P02.txt
'SRFL02 *EQ " " *AND   +
 SRFL01 *EQ " " *AND   +
```
- **雙重篩選**：SRFL01=' '(未確認)且SRFL02=' '(未會計處理)
- **狀態邏輯**：確保只處理完全未處理的收料
- **與ARR070P對比**：ARR070P使用SRFL01='Y'(已確認)

**日期截止範圍實現方式**：
```109:109:東鋼list/ARR071P_P02.txt
SRRVDT *LE ' || &W#RVDT ) +
```
- **範圍比對**：使用≤條件而非等值比對
- **截止邏輯**：包含指定日期及之前的所有收料
- **累積查詢**：提供累積式的未確認收料統計

**日期格式升級實現方式**：
```18:23:東鋼list/ARR071P_P02.txt
/*9908A  START*/
    /*   DCL        VAR(&W#DATE)  TYPE(*DEC)    LEN(6 0) */
    /*   DCL        VAR(&W#UDATE) TYPE(*CHAR)   LEN(6)   */
         DCL        VAR(&W#DATE)  TYPE(*DEC)    LEN(8 0)
         DCL        VAR(&W#UDATE) TYPE(*CHAR)   LEN(8)
/*9908A  END*/
```
- **版本註解**：清楚標示9908A版本的變更
- **長度調整**：從6位數升級為8位數
- **型態一致**：數值和字串變數同步調整

#### 挪用影響評估

**正面影響**：
- **查詢效率提升**：%SST首位比對大幅減少查詢時間
- **業務邏輯清晰**：未確認狀態篩選明確區分處理範圍
- **日期精確度**：8位數日期格式解決Y2K問題
- **功能彈性**：截止日期邏輯提供靈活的查詢範圍

**潛在風險**：
- **維護複雜性**：%SST函數增加查詢邏輯理解難度
- **數據依賴性**：收料編號首位必須嚴格對應廠區代碼
- **狀態管理**：SRFL01/02的組合邏輯需要精確理解

**維護注意事項**：
- 收料編號格式變更需檢查%SST切割邏輯
- 收料確認流程變更需調整SRFL01/02篩選條件
- 日期格式相關程式需確保8位數格式一致性

### 重要變數定義表

| 變數名稱 | 型態 | 長度 | 用途說明 |
|----------|------|------|----------|
| &S#RVDP | *CHAR | 1 | 收料廠區代碼(P/M/T/H/K) |
| &S#RVDT | *CHAR | 8 | 收料截止日期(YYYYMMDD) |
| &W#RVDT | *CHAR | 8 | 收料截止日期(批次處理用) |
| &W#FLAG | *CHAR | 1 | UTS102R驗證結果旗標 |

## 5. 🎯 輸出/入螢幕布局

### 螢幕布局完整視覺化
```
+----------------------------------------------------------+
|  12/28/24     東鋼金屬股份有限公司               ARR071S  |
|  10:30:25     應收入庫未確認收料報表             SYS001   |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|       請輸入您的條件：                                   |
|                       1.收料廠區：[_] (P:台北 M:台中     |
|                                      T:臺南 H:高雄       |
|                                      K:嘉義)             |
|                       2.收料日期：[____/__/__]           |
|                                   (系統日期以前者列印)   |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
| F3:離開     F12:回到主畫面        ENTER:確認             |
| [錯誤訊息顯示區]                                         |
+----------------------------------------------------------+
```

### 🎯 畫面欄位詳細說明

| 欄位標題 | 欄位名稱 | 輸入長度 | 型態 | 屬性 | 檢核規則 |
|----------|----------|----------|------|------|----------|
| 收料廠區 | S#RVDP | 1 | A | 輸入 | VALUES('P' 'M' 'T' 'H' 'K') |
| 收料日期 | S#RVDT | 8 | Y | 輸入 | EDTWRD('    /  /  ') |

#### 收料廠區代碼說明
- **P**：台北廠區
- **M**：台中廠區  
- **T**：臺南廠區
- **H**：高雄廠區
- **K**：嘉義廠區

#### 收料日期功能說明
- **截止日期邏輯**：系統將列印此日期(含)以前的未確認收料
- **累積式查詢**：不限定特定日期，而是範圍查詢
- **業務用途**：管理者可掌握截至某日期的待確認收料狀況

### 🎯 畫面控制邏輯

#### 指示器控制
- **指示器51**：收料廠區欄位錯誤控制(PC+RI)
- **指示器52**：收料日期欄位錯誤控制(PC+RI)
- CA03(03)：F3功能鍵控制
- CA12(12)：F12功能鍵控制

### 功能鍵詳細定義

| 功能鍵 | 功能說明 | 處理邏輯 | 系統行為 |
|--------|----------|----------|----------|
| F3 | 離開程式 | IN03='1' | 直接結束程式回到呼叫點 |
| F12 | 回到主畫面 | IN12='1' | 回到主系統畫面 |
| Enter | 確認執行 | 進行參數驗證 | 驗證成功後提交批次作業 |

### 操作流程

1. **畫面顯示**：顯示未確認收料報表參數輸入畫面
2. **廠區選擇**：選擇要處理的收料廠區(必填)
3. **日期設定**：輸入收料截止日期(系統日期以前者列印)
4. **確認執行**：按Enter開始驗證並執行報表處理

## 6. 🎯 處理流程程序說明

### 🎯 主程序邏輯深度分析

#### 程式執行流程圖
```mermaid
flowchart TD
    A[PGM程式開始] --> B[宣告所有變數]
    B --> C[DCLF畫面檔案]
    C --> D[RTVJOBA取得工作資訊]
    D --> E{檢查執行類型}
    E -->|INT='0'批次| F[GOTO BATCH]
    E -->|INT='1'互動式| G[從LDA取得系統資訊]
    G --> H[取得當前系統日期]
    H --> I[設定預設收料日期]
    I --> J[INPUT:參數輸入迴圈]
    J --> K[SNDRCVF顯示畫面]
    K --> L{檢查功能鍵}
    L -->|IN03='1' OR IN12='1'| M[RETURN結束]
    L -->|Enter| N[清除錯誤指示器]
    N --> O[收料廠區必填檢核]
    O --> P{S#RVDP是否空白}
    P -->|是| Q[設定IN51='1']
    Q --> R[顯示廠區必填錯誤]
    R --> J
    P -->|否| S[日期格式驗證準備]
    S --> T[設定UTS102R參數]
    T --> U[CALL UTS102R驗證]
    U --> V{W#FLAG檢查}
    V -->|≠'0'| W[設定IN52='1']
    W --> X[顯示格式錯誤訊息]
    X --> J
    V -->|='0'| Y[參數儲存LDA]
    Y --> Z[儲存廠區至LDA位置1]
    Z --> AA[儲存日期至LDA位置2-9]
    AA --> BB[SBMJOB提交批次作業]
    BB --> CC[設定進度訊息至LDA位置601]
    CC --> M
    F --> DD[BATCH:批次處理開始]
    DD --> EE[從LDA讀取所有參數]
    EE --> FF[ARR071T報表檔案設定]
    FF --> GG[OVRPRTF設定報表格式]
    GG --> HH[SARVIN檔案覆蓋]
    HH --> II[SARCVF檔案覆蓋]
    II --> JJ[OPNQRYF建立未確認查詢]
    JJ --> KK[CALL ARR071R報表處理]
    KK --> LL[CLOF關閉查詢]
    LL --> MM[DLTOVR清除所有覆蓋]
    MM --> NN[ENDPGM程式結束]
```

#### 🎯 詳細處理步驟逐一分析

**步驟1：程式初始化與環境設定**
```14:31:東鋼list/ARR071P_P02.txt
PGM
DCL        VAR(&INT)     TYPE(*CHAR)   LEN(1)
DCL        VAR(&OUTQ)    TYPE(*CHAR)   LEN(10)
DCL        VAR(&W#FLAG)  TYPE(*CHAR)   LEN(1)
DCL        VAR(&W#DATE)  TYPE(*DEC)    LEN(8 0)
DCL        VAR(&W#UDATE) TYPE(*CHAR)   LEN(8)
DCL        VAR(&W#RVDT)  TYPE(*CHAR)   LEN(8)
DCL        VAR(&P#PDAT) TYPE(*CHAR) LEN(8)
DCL        VAR(&P#MODE) TYPE(*CHAR) LEN(1)
DCL        VAR(&P#MTL)  TYPE(*CHAR) LEN(24)
DCL        VAR(&P#LEAP) TYPE(*CHAR) LEN(1)

DCLF       FILE(ARLIB/ARR071S)
```
- 定義核心處理變數和日期驗證參數
- 宣告ARR071S畫面檔案供互動式處理使用
- 包含9908A版本的8位數日期格式升級
- 相較ARR070P簡化(無營業業務變數)

**步驟2：執行模式判斷與系統資訊取得**
```34:46:東鋼list/ARR071P_P02.txt
RTVJOBA    OUTQ(&OUTQ) TYPE(&INT)
IF         COND(&INT *EQ '0') THEN(GOTO BATCH)

RTVDTAARA  DTAARA(*LDA ( 951 35)) RTNVAR(&S#COMP)
RTVDTAARA  DTAARA(*LDA (1011 10)) RTNVAR(&S#DEVI)

RTVJOBA    CYMDDATE(&W#UDATE)
CHGVAR     VAR(&W#UDATE)  VALUE('0' *CAT &W#UDATE)
CHGVAR     VAR(&S#RVDT)  VALUE(&W#UDATE)
```
- 判斷互動式或批次執行模式
- 從LDA取得公司名稱和設備資訊
- 取得當前系統日期作為預設收料截止日期
- 9908A版本改用RTVJOBA CYMDDATE取代RTVSYSVAL

**步驟3：互動式參數輸入與驗證迴圈**
```47:71:東鋼list/ARR071P_P02.txt
INPUT:
SNDRCVF    RCDFMT(AR071F1)
IF         COND(&IN03 *EQ '1' *OR &IN12 *EQ '1') +
           THEN(RETURN)

CHGVAR     VAR(&IN51) VALUE('0')
CHGVAR     VAR(&IN52) VALUE('0')

IF         COND(&S#RVDP *EQ ' ') THEN(DO)
   CHGVAR  VAR(&IN51) VALUE('1')
   CHGVAR  VAR(&S#MSG1) VALUE('收料廠區不可空白')
   GOTO INPUT
ENDDO

CHGVAR     VAR(&P#PDAT) VALUE(&S#RVDT)
CHGVAR     VAR(&P#MODE) VALUE('1')
CALL       PGM(UTS102R) PARM(&P#PDAT &P#MODE +
                             &P#MTL &P#LEAP &W#FLAG)
IF         COND(&W#FLAG *NE '0') THEN(DO)
   CHGVAR  VAR(&IN52) VALUE('1')
   CHGVAR  VAR(&S#MSG1) VALUE('日期格式有誤！')
    GOTO    INPUT
ENDDO
```
- 顯示AR071F1參數輸入畫面
- 檢查F3/F12功能鍵直接結束
- 收料廠區必填驗證
- 調用UTS102R進行專業日期格式驗證

**步驟4：參數儲存與批次作業提交**
```73:91:東鋼list/ARR071P_P02.txt
CHGVAR     VAR(&W#DATE)  VALUE(&W#UDATE)

CHGDTAARA  DTAARA(*LDA (1 1)) VALUE(&S#RVDP)
CHGVAR     VAR(&W#RVDT)       VALUE(&S#RVDT)
CHGDTAARA  DTAARA(*LDA (2 8)) VALUE(&W#RVDT)
SBMJOB     JOB(ARR071P) JOBD(ARJOBD) OUTQ(&OUTQ) +
           RQSDTA('CALL ARR071P')

CHGDTAARA  DTAARA(*LDA (601 70)) +
VALUE('未確認收料會計報表已送入處理程序。')
RETURN
```
- 註解了日期範圍檢核(不進行未來日期檢查)
- 儲存參數至LDA固定位置
- 提交批次作業執行報表處理
- 設定作業進度訊息供使用者查看

**步驟5：批次模式參數讀取與報表處理**
```94:116:東鋼list/ARR071P_P02.txt
BATCH:
RTVDTAARA  DTAARA(*LDA (1 1)) RTNVAR(&S#RVDP)
RTVDTAARA  DTAARA(*LDA (2 8)) RTNVAR(&W#RVDT)

OVRPRTF    FILE(ARR071T) TOFILE(ARLIB/ARR071T) +
           PAGESIZE(66 158) LPI(6) CPI(12) +
           OVRFLW(57) HOLD(*YES) USRDTA('未確收料')
OVRDBF     FILE(SARVIN) TOFILE(DALIB/SARVIN)
OVRDBF     FILE(SARCVF) TOFILE(DALIB/SARCVF) SHARE(*YES)
OPNQRYF    FILE(SARCVF) +
           QRYSLT( +
            'SRFL02 *EQ " " *AND   +
             SRFL01 *EQ " " *AND   +
        %SST(SRRVNO 1 1) *EQ "' || &S#RVDP || '" *AND +
             SRRVDT *LE ' || &W#RVDT ) +
           KEYFLD((SRRVID) (SRRVDT) (SRRVNO))

CALL       PGM(ARR071R)
CLOF       OPNID(SARCVF)
DLTOVR     FILE(*ALL)
```
- 從LDA讀取批次處理參數
- 設定ARR071T報表檔案(158字元寬度、12CPI)
- 設定相關檔案覆蓋
- 建立未確認收料查詢條件
- 調用ARR071R處理報表並清理資源

### 🎯 子程序邏輯分析

#### UTS102R日期驗證程式
- **調用方式**：CALL PGM(UTS102R) PARM(&P#PDAT &P#MODE &P#MTL &P#LEAP &W#FLAG)
- **功能**：專業的日期格式驗證和轉換
- **參數說明**：
  - &P#PDAT：輸入日期
  - &P#MODE：驗證模式('1')
  - &P#MTL：月份資訊輸出
  - &P#LEAP：閏年旗標輸出
  - &W#FLAG：驗證結果('0'=正確)

#### ARR071R報表處理程式
- **調用方式**：CALL PGM(ARR071R)
- **資料來源**：SARCVF未確認查詢結果
- **處理功能**：產生未確認收料會計報表
- **輸出格式**：158字元寬度、12CPI格式

#### 程式調用關係圖
```mermaid
graph TD
    A[ARR071P控制程式] --> B[ARR071S參數輸入畫面]
    A --> C[UTS102R日期驗證程式]
    A --> D[ARR071R報表處理程式]
    
    B --> E[使用者參數輸入]
    C --> F[日期格式驗證]
    D --> G[未確認收料報表產生]
    
    subgraph "參數驗證流程"
        H[必填檢核] --> I[格式檢核]
        I --> J[參數儲存]
    end
    
    subgraph "資料處理流程"
        K[未確認篩選] --> L[查詢建立]
        L --> M[報表產生]
    end
```

### 🎯 特殊邏輯處理

#### 未確認收料篩選邏輯
```106:107:東鋼list/ARR071P_P02.txt
'SRFL02 *EQ " " *AND   +
 SRFL01 *EQ " " *AND   +
```
- **雙重未確認狀態**：SRFL01=' '(未確認收料)且SRFL02=' '(未會計處理)
- **與ARR070P對比**：ARR070P使用SRFL01='Y'(已確認)
- **業務邏輯**：只處理完全未處理的收料項目
- **管理目的**：提供待確認收料的完整清單

#### 收料編號廠區比對邏輯
```108:108:東鋼list/ARR071P_P02.txt
%SST(SRRVNO 1 1) *EQ "' || &S#RVDP || '" *AND +
```
- **切割技術**：使用%SST函數取收料編號第1位
- **廠區對應**：收料編號首位代表所屬廠區
- **效能最佳化**：避免全欄位比對提升查詢效率
- **業務邏輯**：確保只處理指定廠區的收料資料

#### 日期截止範圍邏輯
```109:109:東鋼list/ARR071P_P02.txt
SRRVDT *LE ' || &W#RVDT ) +
```
- **截止邏輯**：使用≤條件而非等值比對
- **累積查詢**：包含指定日期及之前的所有未確認收料
- **管理需求**：提供累積至某日期的未確認狀況
- **與ARR070P對比**：ARR070P使用*EQ(特定日期)

#### 日期範圍檢核簡化邏輯
```74:78:東鋼list/ARR071P_P02.txt
/*        IF         COND(&S#RVDT *GT &W#DATE) THEN(DO)           */
/*           CHGVAR  VAR(&IN52) VALUE('1')                        */
/*           CHGVAR  VAR(&S#MSG1) VALUE('日期不可超過系統日期') */
/*           GOTO    INPUT                                        */
/*        ENDDO                                                   */
```
- **簡化處理**：註解了日期範圍邏輯檢核
- **業務考量**：未確認收料可能包含歷史資料
- **使用彈性**：允許查詢任意日期的未確認收料
- **與ARR070P對比**：ARR070P保留日期範圍檢核

## 7. 🎯 數據操作與轉換分析

### 檔案操作詳解

#### 多檔案覆蓋操作策略
```102:103:東鋼list/ARR071P_P02.txt
OVRDBF     FILE(SARVIN) TOFILE(DALIB/SARVIN)
OVRDBF     FILE(SARCVF) TOFILE(DALIB/SARCVF) SHARE(*YES)
```
- **檔案覆蓋目的**：確保使用正確的檔案庫和版本
- **SHARE(*YES)**：支援多使用者並行存取
- **資源管理**：自動在程式結束時清除覆蓋

#### 未確認收料查詢建立
```104:110:東鋼list/ARR071P_P02.txt
OPNQRYF    FILE(SARCVF) +
           QRYSLT( +
            'SRFL02 *EQ " " *AND   +
             SRFL01 *EQ " " *AND   +
        %SST(SRRVNO 1 1) *EQ "' || &S#RVDP || '" *AND +
             SRRVDT *LE ' || &W#RVDT ) +
           KEYFLD((SRRVID) (SRRVDT) (SRRVNO))
```
- **多重AND條件**：4個主要篩選條件
- **狀態篩選**：雙重未確認狀態檢查
- **字串函數**：%SST進行收料編號切割
- **排序設定**：三層排序邏輯

### 數據轉換邏輯

#### 日期格式轉換處理
```43:44:東鋼list/ARR071P_P02.txt
RTVJOBA    CYMDDATE(&W#UDATE)
CHGVAR     VAR(&W#UDATE)  VALUE('0' *CAT &W#UDATE)
```
- **系統日期取得**：使用RTVJOBA CYMDDATE
- **格式轉換**：前加'0'轉為8位數格式
- **版本升級**：9908A版本改善的日期處理
- **一致性確保**：確保與其他程式日期格式一致

#### LDA參數格式轉換
```80:82:東鋼list/ARR071P_P02.txt
CHGDTAARA  DTAARA(*LDA (1 1)) VALUE(&S#RVDP)
CHGVAR     VAR(&W#RVDT)       VALUE(&S#RVDT)
CHGDTAARA  DTAARA(*LDA (2 8)) VALUE(&W#RVDT)
```
- **位置對應**：參數轉換為LDA固定位置格式
- **型態轉換**：畫面輸入轉為字串格式儲存
- **參數傳遞**：為批次處理準備參數結構
- **簡化結構**：相較ARR070P缺少營業業務參數

### 檢核機制詳解

#### 雙層參數有效性檢核
```55:71:東鋼list/ARR071P_P02.txt
IF         COND(&S#RVDP *EQ ' ') THEN(DO)
   CHGVAR  VAR(&IN51) VALUE('1')
   CHGVAR  VAR(&S#MSG1) VALUE('收料廠區不可空白')
   GOTO INPUT
ENDDO

CALL       PGM(UTS102R) PARM(&P#PDAT &P#MODE +
                             &P#MTL &P#LEAP &W#FLAG)
IF         COND(&W#FLAG *NE '0') THEN(DO)
   CHGVAR  VAR(&IN52) VALUE('1')
   CHGVAR  VAR(&S#MSG1) VALUE('日期格式有誤！')
    GOTO    INPUT
ENDDO
```
- **必填檢核**：收料廠區不可空白
- **格式檢核**：調用UTS102R專業日期驗證
- **錯誤顯示**：設定指示器顯示錯誤欄位
- **流程控制**：檢核失敗返回輸入畫面

#### 未確認狀態檢核機制
```106:107:東鋼list/ARR071P_P02.txt
'SRFL02 *EQ " " *AND   +
 SRFL01 *EQ " " *AND   +
```
- **雙重狀態檢核**：確保收料確實未確認且未會計處理
- **業務邏輯驗證**：只處理需要確認的收料項目
- **數據完整性**：避免處理已確認或已會計處理的資料
- **與ARR070P區分**：明確分離已確認和未確認的處理

## 8. 🎯 錯誤處理程序說明

### 🎯 詳細錯誤代碼清冊

| 錯誤代碼 | 錯誤訊息 | 原因說明 | 處理方式 | 預防措施 |
|----------|---------|---------|---------|----------|
| **USER001** | 功能鍵F3結束 | 使用者按下F3離開程式 | 1. 正常結束程式<br>2. 回到呼叫點 | 使用者操作選擇 |
| **USER002** | 功能鍵F12返回 | 使用者按下F12回到主畫面 | 1. 正常結束程式<br>2. 回到主系統畫面 | 使用者操作選擇 |
| **INPUT001** | 收料廠區不可空白 | 必填欄位S#RVDP未輸入 | 1. 設定IN51='1'<br>2. 顯示錯誤訊息<br>3. 返回輸入畫面 | 加強欄位必填提示 |
| **INPUT002** | 日期格式有誤！ | UTS102R驗證失敗 | 1. 設定IN52='1'<br>2. 顯示格式錯誤<br>3. 返回輸入畫面 | 提供日期格式範例 |
| **SYS001** | UTS102R程式調用失敗 | 日期驗證程式無法執行 | 1. 檢查程式庫路徑<br>2. 確認程式存在<br>3. 重新執行 | 確保UTS102R程式可用 |
| **FILE001** | SARCVF檔案存取失敗 | 收料檔案無法開啟 | 1. 檢查檔案權限<br>2. 確認檔案存在<br>3. 重新設定覆蓋 | 確保收料檔案可用 |
| **FILE002** | ARR071R程式調用失敗 | 報表程式無法執行 | 1. 檢查程式庫<br>2. 確認程式權限<br>3. 重新調用 | 確保報表程式可用 |

### 🎯 系統異常處理邏輯

#### 檔案操作失敗處理
- **覆蓋設定異常**：SARCVF或SARVIN檔案無法存取
- **查詢建立異常**：OPNQRYF指令執行失敗
- **報表檔案異常**：ARR071T報表檔案設定失敗

#### 程式調用失敗處理
- **UTS102R調用異常**：日期驗證程式無法執行
- **ARR071R調用異常**：報表處理程式無法執行
- **參數傳遞錯誤**：LDA參數格式或位置錯誤

#### 資料完整性錯誤處理
- **LDA參數異常**：參數讀取位置或格式錯誤
- **查詢條件異常**：動態SQL組合失敗
- **日期格式異常**：日期格式設定不正確

#### 使用者操作錯誤處理
- **必填欄位空白**：收料廠區未輸入
- **日期格式錯誤**：不符合YYYY/MM/DD格式
- **廠區代碼錯誤**：不在VALUES清單內的代碼

### 🎯 錯誤恢復機制

#### 自動清理保護機制
```114:114:東鋼list/ARR071P_P02.txt
DLTOVR     FILE(*ALL)
```
- **覆蓋清理**：自動清除所有檔案覆蓋設定
- **資源釋放**：確保系統資源正確釋放
- **程式結束保護**：無論正常或異常結束都執行清理

#### 輸入驗證循環機制
```47:71:東鋼list/ARR071P_P02.txt
INPUT:
SNDRCVF    RCDFMT(AR071F1)
IF         COND(&IN03 *EQ '1' *OR &IN12 *EQ '1') +
           THEN(RETURN)

CHGVAR     VAR(&IN51) VALUE('0')
CHGVAR     VAR(&IN52) VALUE('0')
```
- **錯誤重置**：每次迴圈開始清除錯誤指示器
- **持續驗證**：直到所有參數正確才允許繼續
- **使用者友善**：提供清楚的錯誤訊息和修正指引

#### 查詢資源管理機制
```113:113:東鋼list/ARR071P_P02.txt
CLOF       OPNID(SARCVF)
```
- **查詢關閉**：處理完成後立即關閉查詢
- **資源回收**：避免查詢資源累積佔用
- **系統穩定**：防止查詢衝突和記憶體洩漏

#### 日期驗證保護機制
```65:71:東鋼list/ARR071P_P02.txt
CALL       PGM(UTS102R) PARM(&P#PDAT &P#MODE +
                             &P#MTL &P#LEAP &W#FLAG)
IF         COND(&W#FLAG *NE '0') THEN(DO)
   CHGVAR  VAR(&IN52) VALUE('1')
   CHGVAR  VAR(&S#MSG1) VALUE('日期格式有誤！')
    GOTO    INPUT
ENDDO
```
- **專業驗證**：使用UTS102R進行嚴格日期檢核
- **錯誤回饋**：提供明確的格式錯誤訊息
- **流程保護**：確保只有有效日期才能進入處理

## 9. 🎯 備註

### 🎯 特殊注意事項

#### 程式設計特色
- **未確認收料專用**：專門處理SRFL01=' '(未確認)的收料資料
- **截止日期邏輯**：使用≤條件查詢指定日期前的累積未確認收料
- **簡化參數設計**：相較ARR070P省略營業業務篩選功能
- **雙層狀態篩選**：同時檢核SRFL01和SRFL02確保資料正確性

#### 版本演進歷史
- **9905A版本**：調整LDA訊息位置從801改為601
- **9908A版本**：日期格式從6位數升級為8位數(Y2K解決)
- **相較ARR070P**：缺少0710A版本的營業業務擴展功能

#### 查詢邏輯特點
- **未確認狀態**：SRFL01=' '且SRFL02=' '的雙重條件
- **%SST廠區比對**：收料編號首位對應廠區代碼
- **日期截止範圍**：*LE條件實現累積式查詢
- **三層排序**：按營業業務、日期、編號排序

#### LDA參數配置策略
- **位置1**：收料廠區代碼(P/M/T/H/K)
- **位置2-9**：收料截止日期(YYYYMMDD格式)
- **位置601-670**：作業進度訊息區域(9905A版本調整)
- **簡化結構**：相較ARR070P缺少位置11的營業業務參數

#### 檔案關聯架構
- **SARCVF**：收料檔案，篩選未確認狀態資料
- **SARVIN**：收料相關檔案，提供輔助資訊
- **ARR071T**：報表檔案，158字元寬度、12CPI格式
- **ARR071S**：參數輸入畫面，簡化的雙欄位設計

#### 業務處理邏輯
- **未確認狀態管理**：只處理SRFL01=' '的未確認收料
- **會計處理控制**：確保SRFL02=' '的未會計處理資料
- **累積式查詢**：提供截至某日期的未確認收料統計
- **管理報表需求**：協助管理者掌握待確認收料狀況

#### 日期處理機制
- **系統日期取得**：使用RTVJOBA CYMDDATE
- **格式標準化**：統一為8位數YYYYMMDD格式
- **截止邏輯**：≤條件實現彈性的日期範圍查詢
- **專業驗證**：UTS102R提供完整的日期格式檢核

#### 使用者介面設計
- **簡化輸入**：只需廠區和截止日期兩個參數
- **清楚說明**：「系統日期以前者列印」的功能提示
- **錯誤處理**：明確的錯誤訊息和修正建議
- **功能鍵支援**：F3離開、F12返回、Enter確認

#### 與ARR070P的關鍵差異
- **確認狀態**：ARR071P處理未確認(SRFL01=' ')，ARR070P處理已確認(SRFL01='Y')
- **日期邏輯**：ARR071P使用≤(截止)，ARR070P使用=(特定)
- **參數複雜度**：ARR071P較簡化，無營業業務篩選
- **報表格式**：ARR071P為158字元12CPI，ARR070P為198字元15CPI

#### 系統整合特點
- 與應收帳款系統完整整合
- 與ARR070P形成已確認/未確認的完整對應
- 依賴標準檔案庫的完整結構
- 整合UTS102R通用日期驗證程式

#### 報表輸出特性
- **格式設定**：158字元寬度適合未確認收料清單
- **字體設定**：12CPI提供清晰的資訊顯示
- **分頁控制**：OVRFLW(57)設定分頁行數
- **輸出管理**：HOLD(*YES)支援輸出暫存和審核 