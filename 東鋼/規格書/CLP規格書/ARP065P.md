# ARP065P 程式規格書

## 基本資料
* **程式編號**：ARP065P
* **程式名稱**：發票每日開立作業
* **程式類型**：CLP (控制語言程式)
* **最後修改日期**：1131129
* **修改者**：S00WCJ

## 程式功能說明
此程式為應收帳款系統中負責控制執行發票每日開立作業的批次控制程式。主要功能為處理銷貨資料並依條件批次產生發票，確保系統每日可自動執行發票開立作業，提高營運效率並減少人工開立發票的作業負擔。

## 檔案架構與關聯圖
```
                                 ┌───────────────┐
                                 │  INVCTL       │
                                 │ (發票控制檔)   │
                                 │               │
                                 └─────┬─────────┘
                                       │
                                       │ 檢查可用發票
                                       ▼
┌───────────────┐              ┌─────────────────┐              ┌───────────────┐
│  TRNDTL       │              │   ARP065P       │              │  INVMST       │
│ (銷貨明細檔)   │◄─────────────┤(發票每日開立作業)├─────────────►│ (發票主檔)    │
│               │   讀取未開立   │                │   寫入發票     │               │
└───────┬───────┘   銷貨資料     └────────┬───────┘   資料        └─────┬─────────┘
        │                               │                          │
        │                               │                          │
        │                               │                          │
        │                               │                          │
        │                               ▼                          │
        │                      ┌─────────────────┐                 │
        │                      │   子程式調用     │                 │
        │                      │                 │                 │
        │                      └────────┬────────┘                 │
        │                               │                          │
        │                               │                          │
        ▼                               ▼                          ▼
┌───────────────┐              ┌─────────────────┐         ┌────────────────┐
│ ARP065R1      │              │ ARP065R2/R3/R4  │         │  INVDTL        │
│ (挑選資料)     │              │ (處理各類發票)   │         │ (發票明細檔)   │
│               │              │                 │         │                │
└───────────────┘              └─────────────────┘         └────────────────┘
```

### 主要檔案關聯與資料流向說明：

1. **資料讀取流程**：
   - ARP065P 從 TRNDTL (銷貨明細檔) 讀取未開立發票的銷貨資料
   - 透過 ARP065R1 進行資料篩選與分類處理
   - 從 INVCTL (發票控制檔) 獲取可用發票號碼與字軌資訊

2. **資料處理流程**：
   - 依據不同銷貨類型，呼叫對應子程式 ARP065R2 (隨車發票)、ARP065R3 (隨訂發票)、ARP065R4 (調整發票)
   - 處理銷貨明細中特殊情況如一正一負沖銷 (透過 ARP065R5)
   - 依據業務規則自動合併或分割同客戶的銷貨資料

3. **資料寫入流程**：
   - 生成發票資料寫入 INVMST (發票主檔)
   - 生成發票明細資料寫入 INVDTL (發票明細檔)
   - 更新 INVCTL 中發票號碼使用狀態
   - 更新 TRNDTL 中銷貨資料的發票開立狀態

## 檔案清單與欄位說明

### 主要使用檔案
1. **銷貨明細檔 (TRNDTL)**
   - TDCUNO：客戶編號
   - TDSLMN：業務人員
   - TDACDT：銷貨日期
   - TDINTY：銷貨類別
   - TDORDS：訂單編號
   - TDITEM：項次
   - TDAMT：銷貨金額
   - TDQTY：數量
   - TDPRC：單價
   - TDMARK：備註
   - TDTAX：稅別

2. **發票主檔 (INVMST)**
   - MSINVN：發票號碼
   - MSSEQN：序號
   - MSCUNO：客戶編號
   - MSCUNM：客戶名稱
   - MSINDT：發票日期
   - MSAMT：發票金額
   - MSTAX：稅額
   - MSNET：淨額
   - MSSTAT：狀態

3. **發票明細檔 (INVDTL)**
   - DLINVN：發票號碼
   - DLSEQN：序號
   - DLITEM：項次
   - DLORDS：訂單編號
   - DLQTY：數量
   - DLPRC：單價
   - DLAMT：金額
   - DLTAX：稅額

4. **發票控制檔 (INVCTL)**
   - CTINVT：發票類型
   - CTPRFX：字軌
   - CTSTART：起始號碼
   - CTEND：結束號碼
   - CTCURN：目前號碼

## 輸出/入螢幕布局與說明
本程式為批次處理程式，無直接螢幕輸入輸出，主要由系統排程執行。相關螢幕操作由 ARP065RS 發票每日開立作業畫面程式負責。

## 處理流程程序說明

### 視覺化處理流程
```
┌─────────────────────────────────────────────────┐
│                 程式啟動與初始化                   │
│      (讀取系統參數、檢查執行環境、設定作業參數)      │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│                  檢查發票控制檔                    │
│        (檢核可用發票號碼、字軌、使用狀態)           │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
               ┌───────────────┐
               │ 發票號碼是否足夠 │
               └───────┬───────┘
                       │
      ┌────────────────┴───────────────┐
      │                                │
      ▼                                ▼
┌────────────┐                   ┌────────────┐
│     是     │                   │     否     │
└──────┬─────┘                   └──────┬─────┘
       │                                │
       ▼                                ▼
┌─────────────────────┐         ┌────────────────┐
│ 呼叫 ARP065R1 挑選資料 │         │ 發送通知並結束 │
└──────────┬──────────┘         └────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────┐
│               依銷貨類型分類處理資料                │
└──────────────────────┬──────────────────────────┘
                       │
           ┌───────────┴───────────┐
           │                       │
           ▼                       ▼                      ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│   處理隨車發票資料   │   │   處理隨訂發票資料   │   │   處理調整發票資料   │
│   (呼叫 ARP065R2)   │   │   (呼叫 ARP065R3)   │   │   (呼叫 ARP065R4)   │
└──────────┬──────────┘   └──────────┬──────────┘   └──────────┬──────────┘
           │                          │                          │
           └──────────────────────────┼──────────────────────────┘
                                      │
                                      ▼
                           ┌─────────────────────┐
                           │ 處理一正一負沖銷情況 │
                           │  (呼叫 ARP065R5)    │
                           └──────────┬──────────┘
                                      │
                                      ▼
                           ┌─────────────────────┐
                           │ 合併相同客戶發票資料 │
                           └──────────┬──────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────┐
│                  生成發票資料                     │
│      (寫入發票主檔、明細檔，更新發票號碼)          │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│                  更新銷貨明細檔                   │
│           (標記已開發票的銷貨明細)                │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│                 產生處理結果報表                  │
│             (記錄開立資訊與統計數據)              │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│                   處理結束                        │
│          (記錄處理日誌、釋放資源)                 │
└─────────────────────────────────────────────────┘
```

1. **程式初始化**
   - 讀取系統參數
   - 檢查發票開立條件

2. **資料選取處理**
   - 呼叫 ARP065R1 執行發票開立資料挑選
   - 依照銷貨類別、客戶條件選取未開立發票之銷貨明細

3. **發票開立處理**
   - 依不同發票類型呼叫相應處理程式
   - 隨車發票處理：呼叫 ARP065R2
   - 隨訂發票處理：呼叫 ARP065R3
   - 調整發票處理：呼叫 ARP065R4

4. **特殊處理**
   - 處理銷貨明細中一正一負沖銷情況：呼叫 ARP065R5
   - 檢核相同客戶合併開立發票條件

5. **發票號碼管理**
   - 檢查發票字軌可用性
   - 更新發票號碼使用狀態

6. **完成處理**
   - 更新銷貨明細已開立發票標記
   - 產生處理結果報表
   - 記錄處理日誌

## 子程序處理邏輯說明
1. **檢核處理 (CHECK_PROC)**
   - 檢查發票控制檔狀態
   - 驗證發票號碼是否足夠
   - 處理重複執行檢查

2. **錯誤處理 (ERROR_PROC)**
   - 記錄錯誤訊息
   - 發送錯誤通知
   - 處理錯誤復原機制

## 錯誤處理程序說明與訊息清冊

### 錯誤處理流程

```
錯誤發生
   │
   ▼
┌──────────────────┐
│ 錯誤代碼判斷     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐         ┌─────────────────┐
│ 記錄詳細錯誤訊息 ├────────►│ ERRORLOG 錯誤檔 │
└────────┬─────────┘         └─────────────────┘
         │
         ▼
┌──────────────────┐
│ 根據錯誤類型處理 │
└────────┬─────────┘
         │
         ▼
    ┌────┴─────┐
    │          │
    ▼          ▼
┌─────────┐ ┌────────────┐
│自動修復 │ │ 通知管理員 │
└────┬────┘ └─────┬──────┘
     │           │
     ▼           ▼
┌─────────────────────────┐
│ 程式終止或繼續執行      │
└─────────────────────────┘
```

### 錯誤代碼與處理方式

| 錯誤代碼 | 錯誤訊息 | 原因說明 | 處理方式 | 預防措施 |
|----------|---------|---------|---------|----------|
| **E001** | 發票控制檔鎖定無法存取 | 同時有其他程式正在使用或修改發票控制檔 | 1. 系統自動等待30秒後重試<br>2. 連續3次失敗後發送通知<br>3. 記錄錯誤日誌並結束程式 | 避免同時執行多個需存取發票控制檔的程式 |
| **E002** | 發票號碼不足，請聯絡系統管理員 | 可用發票號碼已低於系統預設的警戒值 | 1. 記錄剩餘可用號碼數量<br>2. 發送通知給系統管理員<br>3. 中止發票開立程序 | 定期檢查並及時申請新發票字軌號碼 |
| **E003** | 銷貨資料不完整，無法開立發票 | 銷貨明細中關鍵欄位（如客戶編號、金額等）資料缺漏 | 1. 記錄不完整的銷貨資料明細<br>2. 將這些資料標記為異常<br>3. 繼續處理其他正常資料 | 加強銷貨資料輸入時的檢核機制 |
| **E004** | 發票開立過程中發生錯誤，請檢查日誌 | 發票開立程序執行過程中系統錯誤 | 1. 記錄詳細錯誤資訊及當前處理狀態<br>2. 回復已處理交易<br>3. 保留失敗資料供人工處理 | 定期檢查系統資源使用狀況並優化程式 |
| **E005** | 發票日期超出合法範圍 | 系統偵測到不合理的發票日期（如未來日期或過早日期） | 1. 檢核銷貨日期合理性<br>2. 對超出範圍的日期記錄資訊<br>3. 使用系統預設日期繼續處理 | 強化日期資料的輸入檢核，避免非法日期 |
| **E006** | 客戶資料不完整，無法開立發票 | 客戶基本資料缺少必要欄位（如統一編號） | 1. 記錄問題客戶清單<br>2. 暫時跳過相關客戶的發票開立<br>3. 通知相關部門補齊資料 | 定期檢核客戶主檔資料完整性 |
| **E007** | 發票金額計算錯誤 | 發票金額、稅額與銷貨明細總和不符 | 1. 自動重新計算金額<br>2. 記錄差異資訊<br>3. 若差異在允許範圍內則自動調整 | 加強金額計算邏輯，定期檢查計算正確性 |
| **E008** | 網路連線異常，無法存取相關檔案 | 系統網路不穩或檔案伺服器異常 | 1. 記錄網路連線詳細錯誤<br>2. 自動等待並重試連線<br>3. 達到重試上限時通知網管人員 | 建立備用連線路徑，強化網路監控機制 |
| **E009** | 程式執行超時 | 處理時間超過預設時間上限 | 1. 記錄當前執行進度<br>2. 將已處理資料提交<br>3. 將未處理資料留待下次執行 | 分批處理大量資料，優化程式執行效率 |
| **E010** | 同步處理時發生衝突 | 多個作業同時更新相同資料 | 1. 記錄發生衝突的資料<br>2. 解決衝突並保護資料完整<br>3. 安排重新處理 | 實施適當的鎖定機制，避免同時修改同一筆資料 |

## 備註
1. 此程式為每日批次作業，一般由排程自動執行
2. 若需手動執行，應在當日銷貨資料處理完成後執行
3. 開立的發票資料將用於後續帳款管理與稅務申報
4. 為確保資料正確性，執行前應確認客戶基本資料與訂單資料已更新
5. 程式執行結果可透過 ARP065RS 畫面程式查詢
6. 2023年修改版本更新了年月格式為6碼
7. 系統每日晚間12點自動執行，處理前一日所有未開立發票的銷貨資料
8. 程式會自動產生處理日誌，儲存於系統日誌資料夾以便追蹤與稽核 