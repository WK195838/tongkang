# ARE001R 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARE001R
- **程式說明**：發票輸入作業（一月一軌）
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARE001R.txt
- **開發人員**：S00WCJ
- **建立日期**：99/08/20 (2010AR517)
- **系統名稱**：應收帳款系統
- **子系統**：發票處理
- **備註**：一月一軌版發票輸入作業，包含發票新增、修改及確認程序
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - CPRBAL：暫收帳管理檔
  - INVMST：發票主檔
  - INVMSTG：發票主檔(新)
  - INVDTL：發票明細檔
  - INVDTLG：發票明細檔(新)
  - TRNDTLL2：交易明細檔
  - CBCUST：客戶基本資料檔
  - SAMAST：業務員主檔
  - HIPROD：銷貨品目檔
  - GENSEQ：編號產生檔
  - ARBTAX：營業稅資料檔
  - ARINVM：發票資料檔
  - ARDSDTL3：折讓單明細檔
  - DELMST：電子發票檔
  - INEDIN：電子發票檔
  - INEDING：電子發票檔(新)
  - INENBU：電子發票檔(業務)
  - ARDLWT：倒貨資料檔
  - CAMBALT：未知檔案(可能是現金餘額檔)
- **顯示檔案**
  - ARE001S：發票輸入作業畫面檔
- **資料區**
  - ARINTRCTL：資料區，用於控制操作
- **相關程式**
  - 無明確關聯程式

## 3. 檔案欄位規格說明

### INVMST（發票主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| INNO | 發票號碼 | 字元 | 主鍵欄位 |
| INCUNO | 客戶編號 | 字元 | 客戶編號 |
| INCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| INEAMT | 發票金額 | 數值 | 發票金額 |
| INFAMT | 發票手續費 | 數值 | 發票手續費 |
| INDATE | 發票日期 | 數值 | 發票日期 |
| INAREA | 區域代碼 | 字元 | 區域代碼 |
| INDECD | 發票狀態 | 字元 | 發票狀態碼 |
| INTYPE | 發票類型 | 字元 | 發票類型 |
| INPRTC | 列印控制 | 字元 | 列印控制旗標 |
| INBAMT | 發票金額2 | 數值 | 發票相關金額 |
| ININDT | 發票到期日 | 數值 | 發票到期日期 |

### INVDTL（發票明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| IVNO | 發票號碼 | 字元 | 主鍵欄位之一 |
| IVACNT | 帳款別 | 字元 | 主鍵欄位之一 |
| IVITEM | 項次 | 數值 | 主鍵欄位之一 |

### INEDIN（電子發票檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| RINEDIN | 電子發票記錄 | 記錄 | 重命名為INEDG |

### 程式使用資料定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| W1CUNO | 1-6 | 6 | 字元 | 客戶編號工作區 |
| S1KIND | 1 | 1 | 字元 | 類別代碼 |
| YMD | 21-28 | 8 | 數值 | 系統日期 |
| YYMM | - | 4 | 數值 | 年月 |
| SCRN | - | 1 | 字元 | 畫面控制旗標 |
| CODE | - | 1 | 字元 | 作業代碼 |
| IVTP | - | 1 | 字元 | 發票類型 |
| MM | - | 2 | 數值 | 月份 |
| EDD | - | 2 | 數值 | 到期日(日) |
| EMM | - | 2 | 數值 | 到期日(月) |
| EYY | - | 2 | 數值 | 到期日(年) |
| RRN | - | 30 | 數值 | 螢幕記錄號 |
| SAMT | - | 110 | 數值 | 金額加總 |
| TTLAMT | - | - | 數值 | 總金額 |

## 4. 輸出/入螢幕布局與說明

### 1. 主畫面布局 (TITLE)
```
<ARE001R>                    [公司名稱]                        [日期]
                            發票輸入作業

                         作業別: [ ]  1.新增  2.修改  3.確認
                         
                         發票類別: [ ]  2.營業用  3.非營業用
                          
                         發票號碼: [        ]
                         
                         西元年月: [    ]
                                      

[錯誤訊息顯示區域]

說明:   F3=結束   F12=取消
```

### 2. 明細操作畫面 (SFLCTL)
```
<ARE001R>                    [公司名稱]                        [日期]
                           發票輸入作業

 作業別: [修改/新增/確認]  發票號碼: [        ]  發票類別: [  ]
 客戶代號: [      ]  客戶名稱: [              ]
 發票日期: [        ]  到期日期: [        ]
 訂單號碼: [        ]  業務員: [      ]
 
 項次   品名代號     品名           數量     單價     金額     稅額
 [  ]  [      ]  [          ]  [      ] [      ] [      ] [      ]
 [  ]  [      ]  [          ]  [      ] [      ] [      ] [      ]
 [  ]  [      ]  [          ]  [      ] [      ] [      ] [      ]
 [  ]  [      ]  [          ]  [      ] [      ] [      ] [      ]
                                           合計:  [           ]

[錯誤訊息顯示區域]

說明:   F3=結束   F12=取消   ENTER=確認
```

## 5. 處理流程程序說明

### 主程序流程
1. 程式啟動後，判斷指示燈90是否開啟（第一次執行）
   - 若是第一次執行，設定系統日期(YMD)、年月(YYMM)、到期日(EDATE)等初始變數
   - 設定SCRN='1'及*IN90='1'，表示進入第一個畫面
2. 程式主體為DO-UNTIL迴圈，直到使用者按下F3(*IN03='1')
   - 依據SCRN值執行不同的子程序：
     - SCRN='1'：執行SR#01（主畫面顯示與輸入）
     - SCRN='2'：執行SR#02（明細畫面處理）
3. 當*IN03='1'時，設定LR指示燈結束程式

### SR#01 - 主畫面處理子程序
1. 顯示主畫面(TITLE)
2. 執行KC#01子程序（檢查結束鍵）
3. 執行CK#01子程序（檢查輸入資料有效性）
4. 若無錯誤(*IN99=OFF)，執行PR#02子程序（準備明細畫面資料）
5. 設定SCRN='2'，進入明細畫面處理

### SR#02 - 明細畫面處理子程序
1. 顯示明細畫面(SFLCTL)
2. 執行KC#01子程序（檢查結束鍵）
3. 若使用者按下KL鍵，回到主畫面(SCRN='1')
4. 若使用者按下KJ鍵(Enter)，執行KJ#02子程序（處理資料輸入）
5. 依據作業代碼(CODE)執行不同的處理：
   - CODE='1'：新增作業，執行CK#02子程序
   - CODE='2'或'3'：修改或確認作業，執行CK#03子程序

### CK#01 - 主畫面資料檢核子程序
1. 檢查作業別(CODE)是否有效
   - 若空白或無效，設定錯誤指示燈(*IN41, *IN99)
2. 根據作業別設定MOD值和*IN70的開關狀態
3. 執行一系列資料檢核：
   - 檢查發票號碼(NO)是否符合作業別要求
   - 檢查發票類型(IVTP)是否為2或3
   - 檢查年月(YYMM)是否有效
   - 檢查電子發票系統是否可用(INENBU)
4. 查詢發票主檔(INVMST)，檢查發票是否存在
5. 計算發票到期日(EDATE)
6. 依作業別執行額外檢核：
   - 新增(CODE='1')：檢查發票是否已存在
   - 確認(CODE='3')：檢查發票狀態、區域代碼等
   - 修改(CODE='2')：檢查發票金額、列印控制等

### PR#02 - 準備明細畫面資料子程序
1. 設定畫面控制指示燈
2. 初始化螢幕記錄號(RRN)、合計金額(SAMT)等變數
3. 清空客戶代號(CUNO)、客戶名稱(CUNM)等顯示欄位
4. 根據作業別選擇處理方式：
   - CODE='1'：執行PR#ADD子程序（新增處理）
   - 其他：執行PR#OTH子程序（其他處理）

### @GETNO - 取得發票號碼子程序
1. 根據發票類型(IVTP)設定產生號碼種類(GEKIND)
2. 從編號產生檔(GENSEQ)取得發票號碼前綴和區間
3. 檢查號碼是否超出範圍
4. 產生完整發票號碼(NO)

## 6. 子程序處理邏輯說明

### KJ#02 - Enter鍵處理子程序
- 功能：處理Enter鍵按下後的資料處理
- 處理邏輯：
  1. 依據作業代碼執行適當的檢核子程序
  2. 若無錯誤(*IN99=OFF)，設定W#FLAG='F'（檔案操作旗標）
  3. 執行FL#02子程序（進行檔案操作）
  4. 若W#FLAG='T'，表示檔案操作成功，執行SR9200子程序
  5. 完成後回到主畫面(SCRN='1')

### SR9200 - 檔案處理完成子程序
- 功能：處理檔案操作完成後的工作
- 處理邏輯：
  1. 根據作業代碼更新相關檔案的狀態
  2. 清除螢幕資料，準備下一筆交易

### PR#ADD - 新增處理子程序
- 功能：處理新增作業的畫面顯示
- 處理邏輯：
  1. 設定作業區域(AREA)為現行作業區域(TXAR)
  2. 執行@GETNO子程序取得新發票號碼
  3. 清除明細畫面記錄(SFLREC)
  4. 建立150筆空白記錄供用戶輸入
  5. 設定指示燈10，表示準備好接受輸入

### FL#02 - 檔案操作子程序
- 功能：根據作業代碼進行檔案操作
- 處理邏輯：
  1. 若為新增(CODE='1')，建立新的發票記錄
  2. 若為修改(CODE='2')，更新既有發票記錄
  3. 若為確認(CODE='3')，更新發票狀態為已確認
  4. 若電子發票功能啟用，同步更新電子發票相關檔案

## 7. 錯誤處理程序說明與訊息清冊

| 錯誤代碼 | 訊息內容 | 說明 |
|---------|---------|------|
| ERR,1 | 請輸入作業別 | 作業別不可為空白 |
| ERR,2 | 作業別錯誤 | 作業別必須是1、2、3或4 |
| ERR,3 | 發票已存在 | 新增作業時發票號碼已存在 |
| ERR,4 | 發票不存在 | 修改或確認作業時發票號碼不存在 |
| ERR,5 | 發票已被確認 | 確認作業時發票已被確認過 |
| ERR,11 | 請輸入發票號碼 | 修改或確認作業時發票號碼不可為空白 |
| ERR,15 | 新增時發票號碼請勿輸入 | 新增作業時應由系統產生發票號碼 |
| ERR,16 | 發票編號產生錯誤 | 從GENSEQ檔案取號時發生錯誤 |
| ERR,17 | 發票類別錯誤 | 發票類別必須是2(營業用)或3(非營業用) |
| ERR,18 | 發票號碼已超出範圍 | 已超出系統設定的發票號碼範圍 |
| ERR,19 | 發票已有金額，無法確認 | 確認時發票金額不應有值 |
| ERR,20 | 區域代碼不一致 | 發票區域代碼與使用者區域代碼不一致 |
| ERR,24 | 發票已有金額，無法修改 | 修改時發票金額不應有值 |
| ERR,25 | 發票已列印，無法修改 | 發票已列印後不可修改 |
| ERR,29 | 區域代碼不一致 | 修改時發票區域代碼與使用者區域代碼不一致 |
| ERR,30 | 發票已作廢，無法修改 | 發票狀態為已作廢，不可修改 |
| ERR,31 | 請輸入年月 | 年月欄位為必填 |
| ERR,32 | 已超過允許操作日期 | 確認作業日期已超過系統允許日期 |
| ERR,41 | 有銷貨金額，無法確認 | 確認時不應有銷貨金額 |
| ERR,46 | 電子發票系統尚未設定 | 電子發票系統參數未設定 |
| ERR,47 | 確認時必須設定列印旗標 | 確認時必須設定列印控制旗標 |

## 8. 備註

1. 此程式為應收帳款系統中的發票輸入作業，支援一月一軌的發票編號格式。
2. 程式歷經多次更新，主要版本包括：
   - 9908A (99/08/20)：初始版本
   - 0001A (100/01/03)：更新版本
   - 0010A (100/10/25)：修正發票注記顯示問題
   - 0111A (101/11/05)：增加發票異常註記
   - 0301A (103/01/19)：發票一併到ARDSDT傳出
   - 0408A (104/08/07)：9聯發票增加註記功能
   - 0409A (104/09/18)：帳款代號3改為5
   - 0612A (106/12/01)：一併寫入電子發票資料
   - 0703A (107/03/29)：檢核發票若已開放不可再開立
   - 0706A (107/06/15)：電子發票作業增加處理旗標及註記
   - 0710A (107/10/31)：二平台發票一併處理時有分支問題
   - 0711A (107/11/30)：增加電子發票上傳檢核
   - 0801A (108/01/23)：增加檢核發票已列印不能再開立
   - 0805A (108/05/09)：電子發票處理LOG檔增加台灣時間資訊
   - 0812A (108/12/12)：增加品項可修改機制，最多可修改8筆
   - 1103A (111/03/21)：增加判斷品項是否為自營品項使用功能
   - 1204A (112/04/10)：將發票付款天數從3日改為1日
   - 1205A (112/05/18)：修正發票建立時一併刪除倒貨資訊
3. 發票處理流程包括新增、修改及確認三個主要功能。
4. 發票類型分為營業用(2)和非營業用(3)兩種。
5. 程式透過GENSEQ檔案自動產生發票號碼。
6. 適用於一月一軌的發票編號模式，年月採六碼格式。
7. 西元107年後增加對電子發票的支援，同步更新電子發票相關資料。
8. 程式使用固定格式的RPG/400語法編寫，符合AS/400傳統開發規範。 