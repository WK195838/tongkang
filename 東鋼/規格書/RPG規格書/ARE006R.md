# ARE006R 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARE006R
- **程式說明**：折讓退回維護作業
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARE006R.txt
- **開發人員**：多人參與修改 (含S00WCJ)
- **系統名稱**：應收帳款系統
- **子系統**：折讓處理
- **備註**：此程式用於處理折讓單退回流程，包含特殊旗標控制和資料傳輸

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - TRNDTL：交易明細檔
  - INVMST：發票主檔
  - INVDTL：發票明細檔
  - HIPROD：銷貨品目檔
  - CBCUST：客戶基本資料檔
  - GENSEQ：序號檔
  - TRNDTLLB：交易明細檔
  - ARDSDTL1/ARDSDTL4/ARDSDTL5：折讓相關資料檔
  - INETRN：電子發票檔
  - HSVOUR：出貨相關檔
  - ARTRLG：記錄檔

### 檔案關聯圖視覺化：

```
+-------------+      +------------+      +------------+
|   TRNDTL    |<---->|  ARE006R   |<---->|   INVMST   |
| (交易明細檔) |      | (折讓退回  |      | (發票主檔)  |
+-------------+      |  維護作業)  |      +------------+
       ^             +------------+             ^
       |                   ^                    |
       v                   |                    v
+-------------+            |            +------------+
| TRNDTLLB    |            |            |   INVDTL   |
| (交易明細檔) |            |            | (發票明細檔)|
+-------------+            |            +------------+
                           |
        +------------------+------------------+
        |                  |                  |
        v                  v                  v
+----------------+   +----------------+   +------------+
|  ARDSDTL1/4/5  |   |     INETRN     |   |   ARTRLG   |
| (折讓相關資料檔)|   |   (電子發票檔)  |   |  (記錄檔)  |
+----------------+   +----------------+   +------------+
        ^
        |
        v
+-------------+
|   CBCUST    |
| (客戶基本檔) |
+-------------+
```

## 3. 檔案欄位規格說明

### 資料結構定義區（欄位切割/借用區域）
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| T#RESV | 1-30 | 30 | 字元 | 保留區，被切割儲存其他資料 |
| D#TXIT | 13-14 | 2 | 字元 | 借用T#RESV的第13-14位元作為項次旗標 |
| D#PDS1 | 19-21 | 3 | 字元 | 借用T#RESV的第19-21位元作為產品識別 |
| R#RESV | 1-10 | 10 | 字元 | 保留區，被切割儲存其他資料 |
| D#DEL | 1 | 1 | 字元 | 借用R#RESV的第1位元作為刪除旗標 |
| T#TXNO | 1-8 | 8 | 字元 | 交易編號，被切割為區域碼和編號 |
| D#AREA | 1 | 1 | 字元 | 切割自T#TXNO的第1位元作為區域代碼 |
| D#VNO1 | 2-3 | 2 | 字元 | 切割自T#TXNO的第2-3位元作為編號前段 |
| D#VNO2 | 4-8 | 5 | 字元 | 切割自T#TXNO的第4-8位元作為編號後段 |
| T2TXNO | 1-8 | 8 | 字元 | 交易編號2，被切割為區域碼和編號 |
| D2AREA | 1 | 1 | 字元 | 切割自T2TXNO的第1位元作為區域代碼 |
| D2VNO1 | 2-3 | 2 | 字元 | 切割自T2TXNO的第2-3位元作為編號前段 |
| D2VNO2 | 4-8 | 5 | 字元 | 切割自T2TXNO的第4-8位元作為編號後段 |
| S4SPE5 | 1-7 | 7 | 字元 | 特殊用途欄位，切割存放其他資料 |
| D#SPE5 | 1-6 | 6 | 字元 | 切割自S4SPE5的第1-6位元 |
| D#TXNO | 1-8 | 8 | 字元 | 交易編號，被切割利用 |
| S4AREA | 1 | 1 | 字元 | 切割自D#TXNO的第1位元作為區域碼 |
| S4VNO1 | 2-3 | 2 | 字元 | 切割自D#TXNO的第2-3位元作為編號前段 |
| S4VNO2 | 4-8 | 5 | 字元 | 切割自D#TXNO的第4-8位元作為編號後段 |
| S4ORNO | 1-9 | 9 | 字元 | 訂單編號，被切割利用 |
| D1AREA | 1 | 1 | 字元 | 切割自S4ORNO的第1位元作為區域代碼 |
| D1ORNO | 2-6 | 5 | 字元 | 切割自S4ORNO的第2-6位元作為訂單編號 |
| D1ORTM | 7-9 | 3 | 字元 | 切割自S4ORNO的第7-9位元作為時間標記 |
| TSRESV | 1-30 | 30 | 字元 | 保留區，被切割儲存特殊資料 |
| D#SPE3 | 1-3 | 3 | 字元 | 切割自TSRESV的第1-3位元作為特殊代碼 |
| ASRESV | 1-10 | 10 | 字元 | 保留區，被切割儲存特殊資料 |
| D1SPE3 | 8-10 | 3 | 字元 | 切割自ASRESV的第8-10位元作為特殊代碼 |
| D#ACDT | 1-8 | 8 | 字元 | 入帳日期，被切割利用 |
| D#ACYM | 1-6 | 6 | 字元 | 切割自D#ACDT的第1-6位元作為年月 |
| D#ACDD | 7-8 | 2 | 字元 | 切割自D#ACDT的第7-8位元作為日期 |
| D#ACMM | 5-6 | 2 | 字元 | 切割自D#ACDT的第5-6位元作為月份 |
| TRPDCD | 1-256 | 256 | 字元 | 產品代碼資料，被切割利用 |
| D#PDCD | 1-5 | 5 | 字元 | 切割自TRPDCD的第1-5位元作為產品代碼 |
| D1PDCD | 6-256 | 251 | 字元 | 切割自TRPDCD的第6-256位元作為產品說明 |
| INVOX | 1-10 | 10 | 字元 | 發票資料，被切割利用 |
| D#INV1 | 1-2 | 2 | 字元 | 切割自INVOX的第1-2位元作為發票前段 |
| D#INV2 | 3-10 | 8 | 字元 | 切割自INVOX的第3-10位元作為發票後段 |
| W#OEOF | 1-2 | 2 | 字元 | 旗標區，被切割為兩個控制旗標 |
| D#OE | 1 | 1 | 字元 | 切割自W#OEOF的第1位元作為旗標1 |
| D#OF | 2 | 1 | 字元 | 切割自W#OEOF的第2位元作為旗標2 |
| D2ACYM | 1-8 | 8 | 字元 | 日期資料，被切割利用 |
| D2YYMM | 1-6 | 6 | 字元 | 切割自D2ACYM的第1-6位元作為年月 |
| D2DD | 7-8 | 2 | 字元 | 切割自D2ACYM的第7-8位元作為日期 |
| W#NOS | 1-8 | 8 | 字元 | 編號資料，被切割利用 |
| W#NOS1 | 2-6 | 5 | 字元 | 切割自W#NOS的第2-6位元作為編號主體 |
| TRMAR1 | 1-30 | 30 | 字元 | 特殊資料區 |
| D#TROR | 1-6 | 6 | 字元 | 切割自TRMAR1的第1-6位元作為訂單編號 |

### 欄位切割視覺化 (TXNO 範例)：

```
T#TXNO (8字元)：[X|XX|XXXXX]
                 ↓  ↓   ↓
D#AREA (1字元)：[X]    區域代碼
D#VNO1 (2字元)：  [XX]  編號前段
D#VNO2 (5字元)：     [XXXXX] 編號後段
```

### 程式使用的主要欄位
| 欄位名稱 | 說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| TXNO | 交易編號 | 字元 | 組合區域碼和編號 |
| IVNO | 發票號碼 | 字元 | 發票明細檔主鍵 |
| IVACNT | 帳款別 | 字元 | 發票明細檔主鍵 |
| IVITEM | 項次 | 數值 | 發票明細檔主鍵 |
| CUNO | 客戶編號 | 字元 | 查詢客戶資料用 |
| INCUNO | 客戶編號 | 字元 | 發票主檔客戶編號 |
| TXDATE | 交易日期 | 數值 | 交易明細檔日期 |
| TXCUNO | 客戶編號 | 字元 | 交易明細檔客戶 |
| TXORNO | 訂單編號 | 字元 | 交易明細檔訂單 |
| TXIVNO | 發票號碼 | 字元 | 交易明細檔發票 |
| D#TYPE | 類型代碼 | 字元 | 特殊用途旗標 |

## 4. 輸出/入螢幕布局與說明

### 折讓退回維護作業畫面
程式提供多個操作畫面，用於:
1. 折讓單資料輸入
2. 折讓資料修改
3. 折讓確認處理
4. 電子發票相關處理

### 螢幕布局視覺化：

```
+----------------------------------------------------------+
|             折讓退回維護作業 (ARE006R)                    |
+----------------------------------------------------------+
| 功能: [ ] 新增 [ ] 修改 [ ] 查詢 [ ] 刪除 [ ] 確認        |
+----------------------------------------------------------+
| 折讓單號: [         ]    狀態: [  ] 確認/未確認           |
| 客戶代號: [         ]    客戶名稱: [                   ] |
| 折讓日期: [YYMMDD  ]    發票號碼: [                   ] |
| 折讓類型: [  ]          關聯單號: [                   ] |
+----------------------------------------------------------+
| 明細項次  品名代碼   品名說明       數量      單價    金額 |
| [  ]    [     ]   [          ]  [      ] [     ] [     ]|
| [  ]    [     ]   [          ]  [      ] [     ] [     ]|
| [  ]    [     ]   [          ]  [      ] [     ] [     ]|
| [  ]    [     ]   [          ]  [      ] [     ] [     ]|
| [  ]    [     ]   [          ]  [      ] [     ] [     ]|
+----------------------------------------------------------+
| 合計金額: [             ]    營業稅: [             ]     |
| 折讓總額: [             ]                                |
+----------------------------------------------------------+
| 功能鍵: F3=離開 F4=查詢 F5=重新整理 F10=確認 F23=刪除    |
+----------------------------------------------------------+
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化系統環境與變數
2. 依據使用者角色設定不同的作業權限
3. 讀取/顯示折讓資料
4. 處理使用者輸入與資料更新
5. 資料確認後更新相關檔案
6. 若為電子發票，則同步更新電子發票相關檔案

### 主要子程序
透過多個資料結構(DS)定義，將關鍵資料切割並存放到更小的欄位中，或借用欄位空間儲存特殊旗標資訊：

1. **欄位切割技術應用**：
   - 使用DS將T#RESV的第13-14位元切割出來當作D#TXIT
   - 將T#TXNO的第1位元切割為D#AREA區域代碼
   - 將S4ORNO的第1位元和第2-6位元分別用於區域碼和訂單編號

2. **借用欄位技術應用**：
   - 借用R#RESV的第1位元作為D#DEL刪除旗標
   - 借用TSRESV的第1-3位元作為D#SPE3特殊代碼
   - 借用D#ACDT的不同部分作為年月和日期資訊

## 6. 特殊欄位使用說明

### 欄位切割儲存技術
程式中使用了多個資料結構(DS)來進行欄位切割或借用，主要應用於：

1. **編號處理**：
   將交易編號切割為區域碼和編號兩部分，方便地區別管理
   ```
   DS
     1   8 T#TXNO
     1   1 D#AREA
     2   3 D#VNO1
     4   8 D#VNO2
   ```

2. **日期處理**：
   將日期欄位切割為年月和日兩部分，方便不同類型的日期查詢
   ```
   DS
     1   8 D#ACDT
     1   6 D#ACYM
     7   8 D#ACDD
     5   6 D#ACMM
   ```

3. **旗標控制**：
   使用單一欄位的不同位置存放多個控制旗標
   ```
   DS
     1   2 W#OEOF
     1   1 D#OE
     2   2 D#OF
   ```

4. **訂單編號處理**：
   將訂單編號切割為區域碼、編號和時間標記
   ```
   DS
     1   9 S4ORNO
     1   1 D1AREA
     2   6 D1ORNO
     7   9 D1ORTM
   ```

## 7. 錯誤處理程序說明與訊息清冊
程式中使用指示器(*IN)處理各種條件和錯誤：
- *IN73：控制畫面清除
- *IN99：控制錯誤處理
- *IN78：控制IFRS檢核結果
- *IN85：新增模式狀態

錯誤訊息主要處理：
- 執行的操作類型檢核
- 根據不同區域(D#AREA)的編號格式檢核
- 日期資料的有效性檢核
- 資料間關聯性的檢核

## 8. 備註
1. 此程式使用了大量的欄位切割和借用技術來節省記憶體空間和提高處理效率。
2. 程式經過多次修改，新增了電子發票相關功能。
3. 程式中有多個版本控制註解（例如0407A、0409A等），表示不同時期的修改。
4. 欄位切割技術讓程式碼複雜度增加，但提高了資料處理的靈活性。
5. 程式中的註解顯示多人參與了程式的開發與維護。 