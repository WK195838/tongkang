# ARR007RBK 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARR007RBK
- **程式說明**：未收帳款清單列印(含客戶英文名)
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARR007RBK.txt
- **開發人員**：不詳（原始碼中有CLJ, YSH, LYW等標記）
- **系統名稱**：應收帳款系統
- **子系統**：報表處理
- **備註**：此程式用於列印未收帳款清單，包含客戶英文名稱

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - INREC：發票主檔
  - INVDTL：發票明細檔
  - CBCUST：客戶基本資料檔
  - HIPROD：銷貨品目檔
- **相關程式**
  - 無明確關聯程式

## 3. 檔案欄位規格說明

### 資料結構定義區（欄位切割/借用區域）
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| W#OEOF | 1-2 | 2 | 字元 | 特殊欄位：切割為D#OE和D#OF兩個1位元欄位 |
| D#OE | 1 | 1 | 字元 | 切割自W#OEOF的第1位元 |
| D#OF | 2 | 1 | 字元 | 切割自W#OEOF的第2位元 |
| PRNM | 1-20 | 20 | 字元 | 品名儲存區域 |
| D#NOF | 20 | 1 | 字元 | 借用PRNM的第20位作為特殊旗標 |
| PRNMX | 1-40 | 40 | 字元 | 擴充品名儲存區域 |
| D#NOX | 40 | 1 | 字元 | 借用PRNMX的第40位作為特殊旗標 |
| U#LOC | 1021 | 1 | 字元 | 位置記號 |

### 程式使用的主要欄位
| 欄位名稱 | 說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| IVNO | 發票號碼 | 字元 | 發票明細檔主鍵 |
| IVACNT | 帳款別 | 字元 | 發票明細檔主鍵 |
| IVITEM | 項次 | 數值 | 發票明細檔主鍵 |
| CUNO | 客戶編號 | 字元 | 查詢客戶資料用 |
| INCUNO | 客戶編號 | 字元 | 發票主檔客戶編號 |
| INDECD | 發票狀態 | 字元 | 發票狀態碼 |
| INPRTC | 列印控制 | 字元 | 發票列印控制旗標 |
| PAG | 頁數 | 數值(3,0) | 報表頁數 |
| LCNT | 行數計數器 | 數值(3,0) | 當前行數 |
| OVRFLW | 溢位行數 | 數值(3,0) | 每頁最大行數 |
| ITEM | 項目計數 | 數值(2,0) | 項目計數 |
| IDN | 檢核碼 | 數值(4,0) | 計算所得的檢核碼 |

## 4. 特殊欄位使用說明

### 欄位切割儲存技術
程式中使用了多個資料結構(DS)來進行欄位切割或借用：

1. **W#OEOF 切割為 D#OE 和 D#OF**
   ```
   I            DS
   I                                        1   2 W#OEOF
   I                                        1   1 D#OE
   I                                        2   2 D#OF
   ```
   這裡將2位元的W#OEOF欄位切割，第1位為D#OE，第2位為D#OF，用於特殊控制。

2. **PRNM 欄位中借用第20位作為D#NOF**
   ```
   I            DS
   I                                        1  20 PRNM
   I                                       20  20 D#NOF
   ```
   這裡借用了20位元的品名欄位PRNM的最後一位作為特殊旗標D#NOF。

3. **PRNMX 欄位中借用第40位作為D#NOX**
   ```
   I            DS
   I                                        1  40 PRNMX
   I                                       40  40 D#NOX
   ```
   同樣地，借用了40位元的擴充品名欄位PRNMX的最後一位作為特殊旗標D#NOX。

4. **檢核碼計算**
   程式在DL#L1子程序中通過一系列的位元操作計算檢核碼：
   ```
   C           N1        ADD  N2        B1      30
   C           N3        ADD  N4        B2      30
   C           N5        ADD  N6        B3      30
   C           N7        ADD  N8        B4      30
   C           N9        ADD  N10       B5      30
   C           B1        ADD  B2        BB1     30
   C           B3        ADD  B4        BB2     30
   C           B5        ADD  N11       BB3     20
   C           BB1       ADD  BB2       BF1     30
   C           BB3       ADD  BF1       CKN1    30
   C           CKN1      MULT MM        CKN2    40
   C           CKN2      ADD  DD        IDN              檢核碼
   ```
   這段代碼將N1-N11等位元進行運算，最終計算出IDN作為檢核碼。

## 5. 處理流程程序說明

### 主程序流程
1. 程式啟動後執行INZ#01子程序進行初始化
2. 依據客戶編號CUNO查詢發票主檔
3. 檢查發票是否存在且未作廢(INDECD≠'D')且未列印(INPRTC=' ')
4. 若符合條件，執行報表列印相關子程序：
   - DL#L1：準備明細列印資料
   - DP#01：處理明細資料
   - TL#L1：列印合計資料

### 主要子程序
1. **INZ#01**：初始化子程序
   - 設定各種KLIST (鍵值串列)
   - 初始化頁碼、行數計數器等變數

2. **@CHKCT**：檢查是否需要換頁
   - 比較當前行數與溢位行數
   - 若需要換頁，執行標題列印

3. **DL#L1**：明細資料準備
   - 初始化各種計數器和合計變數
   - 進行客戶資料查詢
   - 處理發票類型和稅別
   - 計算檢核碼

4. **DP#01**：明細處理
   - 讀取發票明細資料
   - 依據帳款別和狀態代碼進行不同處理
   - 處理品項名稱顯示
   - 使用欄位切割技術處理特殊資料

## 6. 欄位借用與切割應用範例

在程式的實際運作中，可看到幾個典型的欄位借用與切割應用：

1. **品名欄位特殊處理**
   ```
   C           IVPDCD    CHAINHIPROD               31
   C           *IN31     IFEQ '0'
   C                     MOVE ''      W#OEOF
   C                     MOVELIVPDCD    PDCD    1
   C           PDCD      IFNE 'Z'
   C                     MOVE *OFF      *IN30
   C                     MOVELF4CHIN    PRNM
   C                     MOVE D#OF      D#NOF
   C                     ELSE
   C                     MOVE *ON       *IN30
   C                     SELEC
   C           IVPDCD    WHEQ 'Z01'
   C                     MOVELMSG,1     PRNMX
   ```
   這段代碼在處理品項名稱時，根據不同條件將資料存入PRNM或PRNMX，並使用借用的位元D#NOF和D#NOX來標記特殊狀態。

2. **檢核碼計算與儲存**
   程式使用了多個臨時變數(N1-N11, B1-B5等)進行位元操作，最終計算出檢核碼IDN。這是一種典型的欄位切割運算方式，將複雜邏輯切分為多個簡單步驟。

## 7. 錯誤處理程序說明與訊息清冊
程式中使用指示器(*IN)處理各種條件和錯誤：
- *IN31：控制品名資料查詢結果
- *IN44：控制發票主檔查詢結果
- *IN75：控制是否需要換頁
- *IN15, *IN16, *IN77：控制發票類型處理

## 8. 備註
1. 此程式大量使用了傳統RPG的欄位切割和借用技術，特別是在處理品名和檢核碼計算方面。
2. 程式中的註解顯示有多人參與了程式的修改（CLJ, YSH, LYW等）。
3. 欄位借用技術雖然提高了記憶體使用效率，但降低了程式可讀性，需要特別注意在維護時理解這些特殊處理。
4. 檢核碼計算部分是典型的RPG欄位運算切割使用方式，通過多個中間步驟計算出最終結果。 