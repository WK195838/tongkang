# ARE001RD 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARE001RD
- **程式說明**：發票輸入作業（一月一軌）- 允許已承購發票做廢
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARE001RD.txt
- **開發人員**：S00WCJ（修改）
- **建立日期**：未指定
- **系統名稱**：應收帳款系統
- **子系統**：發票處理
- **備註**：本程式為ARE001R的特殊版本，主要功能為允許已承購發票執行作廢功能
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - CPRBAL：暫收帳管理檔
  - INVMST：發票主檔
  - INVDTL：發票明細檔
  - TRNDTLL2：交易明細檔
  - CBCUST：客戶基本資料檔
  - SAMAST：業務員主檔
  - HIPROD：銷貨品目檔
  - GENSEQ：編號產生檔
  - ARBTAX：營業稅資料檔
  - ARCUDT：客戶資料檔
  - CAMBALT：現金餘額檔
- **顯示檔案**
  - ARE001S：發票輸入作業畫面檔
- **資料區**
  - ARINTRCTL：資料區，用於控制操作

### 檔案關聯圖視覺化：

```
+-------------+      +------------+      +------------+
|   CPRBAL    |<---->|  ARE001RD  |<---->|   INVMST   |
| (暫收帳管理檔)|      | (發票輸入  |      | (發票主檔)  |
+-------------+      | 作業-允許  |      +------------+
       ^             |  承購作廢) |             ^
       |             +------------+             |
       v                   ^                    v
+-------------+            |            +------------+
| TRNDTLL2    |            |            |   INVDTL   |
| (交易明細檔) |            |            | (發票明細檔)|
+-------------+            |            +------------+
                           |
        +------------------+------------------+
        |                  |                  |
        v                  v                  v
+----------------+   +----------------+   +------------+
|    CBCUST      |   |     ARBTAX     |   |   GENSEQ   |
| (客戶基本資料檔)|   |  (營業稅資料檔) |   | (編號產生檔)|
+----------------+   +----------------+   +------------+
```

## 3. 檔案欄位規格說明

### INVMST（發票主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| INNO | 發票號碼 | 字元 | 主鍵欄位 |
| INCUNO | 客戶編號 | 字元 | 客戶編號 |
| INCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| INEAMT | 發票金額 | 數值 | 發票金額 |
| INFAMT | 發票手續費 | 數值 | 發票手續費 |
| INDATE | 發票日期 | 數值 | 發票日期 |
| INAREA | 區域代碼 | 字元 | 區域代碼 |
| INDECD | 發票狀態 | 字元 | 發票狀態碼 |
| INDEDT | 處理日期 | 數值 | 狀態變更日期 |
| INFLAG | 處理旗標 | 字元 | C=已作廢 |

### INVDTL（發票明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| IVNO | 發票號碼 | 字元 | 主鍵欄位 |
| IVACNT | 科目代號 | 字元 | 科目代號 |
| IVITEM | 項次 | 數值 | 項次 |
| IVPDCD | 產品代號 | 字元 | 產品代號 |
| IVQTY | 數量 | 數值 | 數量 |
| IVUPRC | 單價 | 數值 | 單價 |
| IVAMT | 金額 | 數值 | 金額 |
| IVDECD | 狀態碼 | 字元 | 狀態碼 |
| IVDEDT | 狀態日期 | 數值 | 狀態日期 |
| IVFLAG | 處理旗標 | 字元 | C=已作廢 |

### TRNDTLL2（交易明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| TXIVNO | 發票號碼 | 字元 | 關聯發票號碼 |
| TXFLAG | 處理旗標 | 字元 | C=已作廢 |
| TXTXDT | 處理日期 | 數值 | 處理日期 |
| TXTXAR | 處理區域 | 字元 | 處理區域 |
| TXACDT | 銷貨日期 | 數值 | 銷貨日期 |
| TXORNO | 訂單編號 | 字元 | 訂單編號 |

### ARBTAX（營業稅資料檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AXAREA | 區域代碼 | 字元 | 區域代碼 |
| AXORNO | 訂單編號 | 字元 | 訂單編號 |
| AXYYMM | 申報年月 | 數值 | 申報年月 |
| AXITEM | 項次 | 數值 | 項次 |
| AXIVNO | 發票號碼 | 字元 | 發票號碼 |
| AXTRFL | 申報旗標 | 字元 | Y=已申報 |
| AXFLAG | 處理旗標 | 字元 | C=已作廢 |

## 4. 輸入/輸出規格

### 輸入畫面
本程式使用 ARE001S 顯示檔案，主要輸入項目為：
- 功能代碼：1=新增，2=修改，3=作廢，4=查詢
- 發票號碼
- 發票日期
- 客戶資料
- 明細資料（含科目、產品、數量、單價、金額）

### 輸出結果
- 發票資料明細顯示
- 作廢後相關檔案資料更新

## 5. 處理邏輯說明

### 主要處理流程
1. 程式初始化設定
2. 依功能代碼執行對應處理：
   - 代碼 1：新增發票資料
   - 代碼 2：修改發票資料
   - 代碼 3：作廢發票資料（本程式特有功能）
   - 代碼 4：查詢發票資料
3. 作廢發票特殊處理：
   - 檢查發票狀態（包含允許承購發票作廢）
   - 更新發票主檔狀態(INDECD='D')
   - 更新發票明細檔狀態(IVDECD='D')
   - 更新交易明細檔狀態(TXFLAG='C')
   - 若需要，更新營業稅資料檔(AXFLAG='C')
   - 調整暫收帳管理檔餘額

### 特殊處理功能
- SR9200：營業稅申報相關處理
- DL#02：作廢發票處理子程序
- CK#03：檢核客戶承購狀態，允許已承購發票作廢

## 6. 特殊功能說明
本程式與標準版ARE001R的主要差異在於：
1. 允許已承購發票進行作廢處理
2. 作廢時不檢核承購狀態限制
3. 作廢後同步處理相關營業稅申報資料
4. 處理發票作廢後的帳務調整

## 7. 異常處理
| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| 41 | 承購客戶例外處理狀態 | 顯示警告但允許繼續處理 |
| 19 | 已承購發票無法處理 | 進行特殊判斷，允許例外處理 |
| 20 | 非本區域發票無法處理 | 檢查區域代碼與使用者權限 |

## 8. 維護紀錄
程式修改主要用於處理承購發票的例外狀況，對已承購發票執行作廢的特殊需求。 