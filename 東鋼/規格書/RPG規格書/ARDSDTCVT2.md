# ARDSDTCVT2 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARDSDTCVT2
- **程式說明**：折讓單鋼筋分攤改抓SRVOUR
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARDSDTCVT2.txt
- **開發人員**：S00WCJ
- **建立日期**：105/10/22
- **系統名稱**：應收帳款系統
- **子系統**：折讓單處理
- **備註**：折讓單鋼筋分攤處理，改為從SRVOUR檔案抓取資料
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - TRNDTLLL：交易明細檔案
  - INVMST：發票主檔
  - INVDTLL4：發票明細檔
  - TRNDTLLB：交易明細檔案B
  - ARDSDTL1：應收帳款折讓單明細
  - ARDSDTL4：折讓單明細參照檔
  - ARDSDTL5：折讓單明細參照檔5 (0510A版本)
  - SRVOURL4：銷貨磅單明細檔 (0510A版本)
  - ARDSDTG：折讓單暫存檔 (0510A版本)
- **顯示檔案**
  - 無
- **資料區**
  - 無
- **相關程式**
  - 無

## 3. 檔案欄位規格說明

### TRNDTLLB（交易明細檔案B）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| TXDATE | 交易日期 | 數字 | 交易發生日期 |
| TXNO | 交易編號 | 字元 | 折讓單號 |
| TXITEM | 項次 | 數字 | 折讓項次 |
| TXCUNO | 客戶編號 | 字元 | 客戶編號 |
| TXCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| TXORNO | 訂單號碼 | 字元 | 訂單編號 |
| TXIVNO | 發票號碼 | 字元 | 發票號碼 |
| TXPDNM | 產品名稱 | 字元 | 產品代碼 |
| TXUPRC | 單價 | 數字 | 單價 |
| TXQTY | 數量 | 數字 | 數量 |
| TXTAX | 稅額 | 數字 | 稅額 |
| TXAMT | 金額 | 數字 | 金額 |
| TXACNT | 帳款別 | 字元 | 帳款類別 |
| TXFL01 | 處理旗標 | 字元 | 處理旗標 |

### SRVOURL4（銷貨磅單明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| SVPNO | 磅單號 | 字元 | 磅單編號 |
| SVITEM | 項次 | 數字 | 項次 |
| SVPCAT | 產品類別 | 字元 | 產品類別 |
| SVPNM | 產品名稱 | 字元 | 產品名稱 |
| SVQTY | 數量 | 數字 | 數量 |
| SVIVNO | 發票號碼 | 字元 | 關聯發票號碼 |

### ARDSDTL5（折讓單明細參照檔5）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A5TXNO | 折讓單號 | 字元 | 折讓單號 |
| A5ITEM | 項次 | 數字 | 折讓項次 |
| A5PDNM | 產品名稱 | 字元 | 產品名稱 |
| A5QTY | 數量 | 數字 | 數量 |
| A5UPRC | 單價 | 數字 | 單價 |
| A5AMT | 金額 | 數字 | 金額 |
| A5PCAT | 產品類別 | 字元 | 產品類別 |

### ARDSDTG（折讓單暫存檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AGTXNO | 折讓單號 | 字元 | 折讓單號 |
| AGITEM | 項次 | 數字 | 折讓項次 |
| AGPDNM | 產品名稱 | 字元 | 產品名稱 |
| AGQTY | 數量 | 數字 | 數量 |
| AGUPRC | 單價 | 數字 | 單價 |
| AGAMT | 金額 | 數字 | 金額 |

### 程式使用資料定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| D#DATS | - | 8 | 字元 | 起始日期參數 |
| D#DATE | - | 8 | 字元 | 結束日期參數 |
| W#DATS | - | 8 | 字元 | 工作起始日期 |
| W#DATE | - | 8 | 字元 | 工作結束日期 |
| W#VQTY | - | 8 | 數字 | 發票總數量 |
| W#AMTT | - | 12 | 數字 | 折讓金額 |
| W#TAX | - | 12 | 數字 | 折讓稅額 |
| D#TXN1 | 1 | 1 | 字元 | 交易編號第一碼 |

## 4. 輸出/入螢幕布局與說明
此程式無直接畫面輸入/輸出，僅透過參數傳遞進行處理。

### 參數說明
| 參數 | 說明 |
|-----|------|
| D#DATS | 起始日期 |
| D#DATE | 結束日期 |

## 5. 處理流程程序說明

### 主程序流程
1. 程式接收起始日期(D#DATS)和結束日期(D#DATE)參數
2. 將參數複製到工作變數(W#DATS, W#DATE)
3. 使用日期區間設定TRNDTLLB檔案的讀取範圍
4. 循環讀取TRNDTLLB檔案的記錄，直到結束
5. 過濾條件：
   - 交易日期(TXDATE)在指定區間內
   - 帳款類別(TXACNT)為'3'
   - 處理旗標(TXFL01)為'Y'
   - 非'H'開頭的交易號碼
   - 產品名稱(TXPDNM)包含'筋'字的記錄
6. 對符合條件的記錄，執行鋼筋分攤處理：
   - 先查詢銷貨磅單明細檔(SRVOURL4)
   - 根據發票號碼找出關聯的磅單記錄
   - 設定分攤比例及金額
7. 在0510A版本中，加入了ARDSDTL5和ARDSDTG檔案的相關處理
8. 對於銷貨磅單明細檔中的鋼筋類產品進行分攤計算
9. 處理完所有符合條件的記錄後，結束程式

## 6. 子程序處理邏輯說明

### SR1000 子程序
- 功能：處理SRVOUR檔案資料
- 處理邏輯：
  1. 使用發票號碼(TXIVNO)查詢銷貨磅單明細檔(SRVOURL4)
  2. 設定條件：只處理產品類別(SVPCAT)為'B'的記錄（鋼筋類）
  3. 計算鋼筋產品總數量
  4. 根據總數量計算分攤金額及稅額
  5. 將分攤結果寫入ARDSDTL5檔案

### SR2000 子程序
- 功能：處理折讓單暫存檔
- 處理邏輯：
  1. 將分攤後的資料寫入ARDSDTG暫存檔
  2. 設置各項欄位值
  3. 寫回暫存檔以供後續處理

## 7. 錯誤處理程序說明與訊息清冊
此程式的錯誤處理邏輯主要包括：
- 只處理產品名稱含'筋'的記錄
- 只處理SRVOURL4檔案中產品類別為'B'的記錄
- 透過檔案操作的狀態指示燈進行判斷：
  - 指示燈55：檔案讀取結束指示燈
  - 指示燈90：磅單記錄檢查指示燈

## 8. 備註

1. 此程式專門處理鋼筋類折讓單的分攤問題，與一般折讓單處理不同。
2. 程式的主要特點是改為使用SRVOUR銷貨磅單明細檔來獲取鋼筋分攤資料，而不是從發票系統取得。
3. 在0510A版本中增加了對ARDSDTL5折讓單明細參照檔5的處理，用於存儲分攤後的結果。
4. 0510A版本還增加了ARDSDTG折讓單暫存檔的處理功能。
5. 分攤計算基於銷貨磅單中的鋼筋產品資料，更準確反映實際銷貨情況。
6. 此程式為批次處理程式，無需使用者互動，完全透過參數和檔案操作執行。
7. 程式僅處理產品名稱含有"筋"字的折讓單記錄，其他產品類型由其他程式處理。
8. 使用固定格式的RPG/400語法編寫，符合AS/400傳統開發規範。 