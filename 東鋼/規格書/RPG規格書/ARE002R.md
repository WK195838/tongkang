# ARE002R 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARE002R
- **程式說明**：調整維護作業
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARE002R.txt
- **開發人員**：S00WCJ（多次修改）
- **建立日期**：98/12/03（最初版本 2009AR388）
- **系統名稱**：應收帳款系統
- **子系統**：調整處理
- **備註**：此程式用於客戶帳款的調整維護作業，含新增、修改、刪除及查詢功能
- **最後修改日期**：113/07/11（2024AR00023）

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - TRNDTL：交易明細檔
  - TRNDTLL5：交易明細子檔
  - SAMAST：業務員主檔
  - HIPROD：銷貨品目檔
  - CBCUST：客戶基本資料檔
  - GENSEQ：編號產生檔
  - ARDLWT：倒貨資料檔
  - AMCTRL：控制檔
  - ACCTRL：控制檔
  - INVMST：發票主檔
- **顯示檔案**
  - ARE002S：調整維護作業畫面檔
- **資料區**
  - ARCTL：控制區，用於管理調整作業的執行狀態

### 檔案關聯圖視覺化：

```
+-------------+      +------------+      +------------+
|   TRNDTL    |<---->|  ARE002R   |<---->|   CBCUST   |
| (交易明細檔) |      | (調整維護  |      | (客戶基本檔)|
+-------------+      |   作業)    |      +------------+
       ^             +------------+             ^
       |                   ^                    |
       v                   |                    v
+-------------+            |            +------------+
| TRNDTLL5    |            |            |   HIPROD   |
| (交易明細檔) |            |            | (銷貨品目檔)|
+-------------+            |            +------------+
                           |
        +------------------+------------------+
        |                  |                  |
        v                  v                  v
+----------------+   +----------------+   +------------+
|    SAMAST      |   |     GENSEQ     |   |   ARDLWT   |
| (業務員主檔)   |   |   (編號產生檔)  |   | (倒貨資料檔)|
+----------------+   +----------------+   +------------+
```

## 3. 檔案欄位規格說明

### TRNDTL（交易明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| TXCODE | 交易代碼 | 字元 | 主鍵欄位，SA08=調整單 |
| TXNO | 交易號碼 | 字元 | 主鍵欄位，調整單號碼 |
| TXITEM | 項次 | 數值 | 主鍵欄位，項次 |
| TXACDT | 帳款日期 | 數值 | 調整日期 |
| TXCUNO | 客戶編號 | 字元 | 客戶編號 |
| TXCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| TXORNO | 訂單編號 | 字元 | 訂單編號 |
| TXPDCD | 產品代號 | 字元 | 產品代碼 |
| TXQTY | 數量 | 數值 | 數量 |
| TXPRC | 單價 | 數值 | 單價 |
| TXAMT | 金額 | 數值 | 金額 |
| TXRESV | 備註 | 字元 | 備註欄位 |

### GENSEQ（編號產生檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| GEKIND | 種類代碼 | 字元 | 主鍵欄位，調整單=SA |
| GEPRIN | 前置字元 | 字元 | 主鍵欄位，調整單編號前置字元 |
| GEPRE | 前置值 | 字元 | 前置值 |
| GECUNO | 目前序號 | 數值 | 目前使用序號 |
| GEENNO | 最大序號 | 數值 | 最大可用序號 |

### CBCUST（客戶基本資料檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| CBCUNO | 客戶編號 | 字元 | 主鍵欄位 |
| CBCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| CBSANO | 統一編號 | 字元 | 統一編號 |
| CBSLMN | 業務人員 | 字元 | 業務人員代號 |

### SAMAST（業務員主檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| KOREA | 區域代碼 | 字元 | 主鍵欄位 |
| KORNO | 業務編號 | 字元 | 主鍵欄位 |
| KORTM | 項次 | 數值 | 主鍵欄位 |
| KORNM | 業務名稱 | 字元 | 業務人員名稱 |

## 4. 輸入/輸出規格

### 輸入畫面
本程式使用 ARE002S 顯示檔案，主要分為三個畫面：
1. **主畫面（TITLE）**：
   - 功能代碼：1=新增，2=修改，3=刪除，4=查詢
   - 調整單號碼
   - 區域代碼：P=總公司、T=台中、U=高雄、H=花蓮、K=高榮、M=民生等

2. **調整單明細畫面（SFCTL1）**：
   - 客戶資料
   - 訂單編號
   - 調整明細項目清單
   - 功能鍵：F3=結束、F8=明細輸入、F10=儲存、F12=返回

3. **明細輸入畫面（SFCTL2）**：
   - 調整類別
   - 產品名稱
   - 數量、單價、金額
   - 調整單號碼
   - 產品代號
   - 虛轉代碼
   - 稅別
   - 功能鍵：F3=結束、F5=更新、F10=儲存、F12=返回

### 輸出結果
- 調整單資料存檔
- 相關檔案資料更新

## 5. 處理邏輯說明

### 主要處理流程
1. 程式初始化設定
2. 依功能代碼執行對應處理：
   - 代碼 1：新增調整單資料
   - 代碼 2：修改調整單資料
   - 代碼 3：刪除調整單資料
   - 代碼 4：查詢調整單資料
3. 調整單處理流程：
   - 檢核客戶資料
   - 輸入明細資料
   - 計算金額合計
   - 儲存調整單資料
   - 更新相關檔案

### 特殊處理功能
- SR3200：儲存調整單資料
- SR3400：更新明細資料
- SR3500：統計數量計算
- FL#02：檔案更新處理

## 6. 特殊功能說明
1. **區域代碼處理**：
   - 支援多種區域代碼：P=總公司、T=台中、U=高雄、H=花蓮、K=高榮、M=民生、V=萬大、Q=南港、R=彰化、X=宏竑、I=加工處、O=海陸、D=東浦、N=大寮
   - 依據區域代碼產生不同前置字元的調整單號

2. **稅別處理**：
   - 支援業務稅別設定及稅額計算
   - 提供稅別分類：S=含稅、Z=零稅率、F=免稅

3. **批次處理**：
   - 允許一次輸入多筆調整明細
   - 支援明細合併計算

4. **例外處理**：
   - 處理特殊調整需求，如倒貨調整
   - 支援多種調整類型

## 7. 異常處理
| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| 25 | 明細項目超過限制 | 限制明細項目不超過99筆 |
| 26 | 明細項目已儲存 | 顯示已儲存的明細數量 |
| 27 | 無明細資料 | 必須至少輸入一筆明細資料 |
| 37 | 明細項目超過99筆 | 警告訊息，建議分批處理 |

## 8. 維護紀錄
此程式有多次修改更新，主要包含：
- 98/12/03：初版建立（2009AR388）
- 100/07/04：新增倒貨調整功能
- 104/09/18：新增產品代碼3及5類處理
- 106/10/11：新增多區域處理功能
- 108/03/23：擴充區域代碼
- 109/06/02：新增產品名稱檢核功能
- 110/01/18：新增稅別檢核功能
- 113/07/11：新增多種區域代碼支援（2024AR00023） 