# ARDSDTCVT@ 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARDSDTCVT@
- **程式說明**：折讓單漏分攤之資料補入
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARDSDTCVT@.txt
- **開發人員**：S00WCJ
- **建立日期**：105/09/01
- **系統名稱**：應收帳款系統
- **子系統**：折讓單處理
- **備註**：處理折讓單漏分攤之資料補入，計算平均單價並更新折讓單資料
- **聯絡電話**：未指定

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - TRNDTLLL：交易明細檔案
  - INVMST：發票主檔
  - INVDTLL4：發票明細檔
  - TRNDTLLB：交易明細檔案B
  - ARDSDTL1：應收帳款折讓單明細
  - ARDSDTL4：折讓單明細參照檔
- **顯示檔案**
  - 無
- **資料區**
  - 無
- **相關程式**
  - 無

## 3. 檔案欄位規格說明

### TRNDTLLB（交易明細檔案B）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| TXDATE | 交易日期 | 數字 | 交易發生日期 |
| TXNO | 交易編號 | 字元 | 折讓單號 |
| TXITEM | 項次 | 數字 | 折讓項次 |
| TXCUNO | 客戶編號 | 字元 | 客戶編號 |
| TXCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| TXORNO | 訂單號碼 | 字元 | 訂單編號 |
| TXIVNO | 發票號碼 | 字元 | 發票號碼 |
| TXPDNM | 產品名稱 | 字元 | 產品代碼 |
| TXUPRC | 單價 | 數字 | 單價 |
| TXQTY | 數量 | 數字 | 數量 |
| TXTAX | 稅額 | 數字 | 稅額 |
| TXAMT | 金額 | 數字 | 金額 |
| TXACNT | 帳款別 | 字元 | 帳款類別 |
| TXFL01 | 處理旗標 | 字元 | 處理旗標 |
| TXRESV | 保留欄位 | 字元 | 項次資訊 |

### INVDTLL4（發票明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| IVPDCD | 產品代碼 | 字元 | 產品代碼 |
| IVQTY | 數量 | 數字 | 發票數量 |
| IVAMT | 金額 | 數字 | 發票金額 |
| IVACNT | 帳款別 | 字元 | 發票帳款類別 |

### ARDSDTL4（折讓單明細參照檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| ASRESV | 保留欄位 | 字元 | 資料狀態 |

### 程式使用資料定義：
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| D#DATS | - | 8 | 字元 | 起始日期參數 |
| D#DATE | - | 8 | 字元 | 結束日期參數 |
| W#DATS | - | 8 | 字元 | 工作起始日期 |
| W#DATE | - | 8 | 字元 | 工作結束日期 |
| W#VQTY | - | 8 | 數字 | 發票總數量 |
| W#AMTT | - | 12 | 數字 | 折讓金額 |
| W1AMTT | - | 12 | 數字 | 折讓稅額 |
| W#PRIC | - | 5.3 | 數字 | 計算平均單價 |

## 4. 輸出/入螢幕布局與說明
此程式無直接畫面輸入/輸出，僅透過參數傳遞進行處理。

### 參數說明
| 參數 | 說明 |
|-----|------|
| D#DATS | 起始日期 |
| D#DATE | 結束日期 |

## 5. 處理流程程序說明

### 主程序流程
1. 程式接收起始日期(D#DATS)和結束日期(D#DATE)參數
2. 將參數複製到工作變數(W#DATS, W#DATE)
3. 使用日期區間設定TRNDTLLB檔案的讀取範圍
4. 循環讀取TRNDTLLB檔案的記錄，直到結束
5. 過濾條件：
   - 交易日期(TXDATE)在指定區間內
   - 帳款類別(TXACNT)為'3'
   - 處理旗標(TXFL01)為'Y'
   - 非'H'開頭的交易號碼
   - 排除特定的交易編號(如U01324、U01532等)
6. 使用KEY03查詢該筆交易是否存在於ARDSDTL4檔案
   - 若存在(指示燈53為開)，則執行SR1000子程序
   - 若不存在(指示燈53為關)，則執行SR2000子程序
7. 處理完所有符合條件的記錄後，結束程式

## 6. 子程序處理邏輯說明

### SR1000 子程序
- 功能：新增ARDSDT檔案記錄
- 處理邏輯：
  1. 設定發票號碼(IVNO)和產品代碼(W#PDCD)
  2. 初始化發票總數量(W#VQTY)為0
  3. 讀取INVDTLL4檔案，計算相同產品的總數量：
     - 只計算帳款類別(IVACNT)為'1'的記錄
     - 累加數量到W#VQTY
  4. 將折讓金額(TXAMT)和稅額(TXTAX)存入工作變數
  5. 計算平均單價：折讓金額(W#AMTT) / 發票總數量(W#VQTY)
  6. 讀取TRNDTLLB檔案相關記錄
  7. 清除ARDSDT檔案記錄區域
  8. 設定折讓單各欄位資料：
     - 交易號碼、項次、數量、產品名稱、單價等
     - 新增折讓單標記、類別、客戶資料等
  9. 寫入ARDSDT檔案

### SR2000 子程序
- 功能：修改ARDSDT檔案記錄
- 處理邏輯：
  1. 讀取既有的折讓單資料
  2. 更新需要修改的欄位值
  3. 寫回ARDSDT檔案

## 7. 錯誤處理程序說明與訊息清冊
此程式無特定的錯誤處理邏輯或訊息，主要透過檔案操作的狀態進行判斷：
- 指示燈53：ARDSDTL4檔案查詢結果指示燈
- 指示燈55：INVDTLL4和TRNDTLLB檔案讀取結束指示燈

## 8. 備註

1. 程式特別排除了多個特定交易編號，如U01324、U01532、U01488等，這些交易的發票產品名稱與銷貨產品名稱不符，無法分攤。
2. 使用了多個工作檔案及暫存變數來處理折讓單分攤計算：
   - TRNDTLLB：取得折讓資料
   - INVDTLL4：取得發票明細資料
   - ARDSDTL4：確認是否已存在折讓單記錄
3. 計算邏輯為：平均單價 = 折讓金額 / 發票對應產品的總數量。
4. 此程式為批次處理程式，無需使用者互動，完全透過參數和檔案操作執行。
5. 使用多個KLIST索引鍵(KEY01~KEY04)來存取不同檔案的相關記錄。
6. 使用固定格式的RPG/400語法編寫，符合AS/400傳統開發規範。
7. 對於新增和修改折讓單資料使用不同的子程序處理，增加程式的模組化和可維護性。
8. 需要正確的日期範圍參數才能有效處理資料，否則可能無法找到符合條件的記錄。 