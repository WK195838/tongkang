# ARE002RF 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARE002RF
- **程式說明**：關帳後調整單作廢（財會）
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARE002RF.txt
- **開發人員**：S02YSH（原始）、S00WCJ（修改）
- **建立日期**：89/02/18
- **系統名稱**：應收帳款系統
- **子系統**：調整處理
- **備註**：此程式用於關帳後調整單作廢處理，針對調整單進行逆向處理以作廢
- **最後修改日期**：104/09/18（2015AR953）

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - TRNDTL：交易明細檔
  - GENSEQ：編號產生檔
  - AMCTRL：控制檔（區域）
  - ACCTRL：控制檔（財會）
- **顯示檔案**
  - ARE002SF：調整單作廢畫面檔

### 檔案關聯圖視覺化：

```
+-------------+      +------------+      +------------+
|   TRNDTL    |<---->|  ARE002RF  |<---->|   GENSEQ   |
| (交易明細檔) |      | (調整單作廢 |      | (編號產生檔)|
+-------------+      |    作業)   |      +------------+
                     +------------+
                           ^
                           |
        +------------------+------------------+
        |                                     |
        v                                     v
+----------------+                    +----------------+
|    AMCTRL      |                    |    ACCTRL      |
| (區域控制檔)   |                    |  (財會控制檔)   |
+----------------+                    +----------------+
```

## 3. 檔案欄位規格說明

### TRNDTL（交易明細檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| TXCODE | 交易代碼 | 字元 | 主鍵欄位，AR05=調整單 |
| TXNO | 交易號碼 | 字元 | 主鍵欄位，調整單號碼 |
| TXITEM | 項次 | 數值 | 主鍵欄位，項次 |
| TXACDT | 帳款日期 | 數值 | 調整日期 |
| TXCUNO | 客戶編號 | 字元 | 客戶編號 |
| TXCUNM | 客戶名稱 | 字元 | 客戶名稱 |
| TXORNO | 訂單編號 | 字元 | 訂單編號 |
| TXPDNM | 產品名稱 | 字元 | 產品名稱 |
| TXQTY | 數量 | 數值 | 數量 |
| TXUPRC | 單價 | 數值 | 單價 |
| TXAMT | 金額 | 數值 | 金額 |
| TXRESV | 備註 | 字元 | 備註欄位 |
| TXIVNO | 發票號碼 | 字元 | 發票號碼，#=已作廢 |
| TXFL02 | 處理旗標 | 字元 | Y=已處理 |

### GENSEQ（編號產生檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| GEKIND | 種類代碼 | 字元 | 主鍵欄位，05=作廢調整單 |
| GEPRIN | 前置字元 | 字元 | 主鍵欄位，區域代碼 |
| GECUNO | 目前序號 | 數值 | 目前使用序號 |

### AMCTRL（區域控制檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| A5AREA | 區域代碼 | 字元 | 主鍵欄位 |
| A5YYMM | 年月 | 數值 | 主鍵欄位 |
| A5FG12 | 關帳旗標 | 字元 | Y=已關帳 |

### ACCTRL（財會控制檔）
| 欄位名稱 | 欄位說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| AAAREA | 區域代碼 | 字元 | 主鍵欄位 |
| AAYYMM | 年月 | 數值 | 主鍵欄位 |
| AAFSYS | 功能系統 | 字元 | 主鍵欄位，SA=應收系統 |
| AAESFG | 關帳旗標 | 字元 | Y=已關帳 |

## 4. 輸入/輸出規格

### 輸入畫面
本程式使用 ARE002SF 顯示檔案，主要包含：
1. **主畫面（AR002F1）**：
   - 調整單號碼
   - 功能鍵：F3=結束、F10=處理、F12=返回

### 輸出結果
- 反向調整單資料存檔
- 原調整單狀態更新

## 5. 處理邏輯說明

### 主要處理流程
1. 程式初始化設定
2. 畫面顯示輸入調整單號碼
3. 調整單作廢處理：
   - 檢核調整單是否存在
   - 檢核調整單是否已開立發票或已作廢
   - 檢核是否已關帳
   - 產生新的作廢調整單號碼
   - 讀取原調整單所有明細資料
   - 建立反向金額調整單
   - 標記原調整單為已作廢

### 特殊處理功能
- SR1000：畫面輸入處理
- SR2000：調整單作廢處理
- WTRSR：作廢調整單明細資料建立

## 6. 特殊功能說明
1. **關帳後處理**：
   - 本程式專為關帳後的調整單作廢設計
   - 檢查 AMCTRL 或 ACCTRL 的關帳旗標

2. **反向調整**：
   - 建立與原調整單相同金額但負號的新調整單
   - 保持原調整單的明細結構，僅變更金額正負號

3. **標記作廢**：
   - 原調整單的發票號碼欄位標記為 '#'
   - 設定處理旗標 TXFL02='Y'

4. **備註處理**：
   - 在備註欄位第15位置標記 'D'，表示作廢
   - 保留原始備註資訊

## 7. 異常處理
| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| 1 | 調整單號碼不存在 | 重新輸入正確的調整單號碼 |
| 2 | 該月份未關帳，請使用正常程序作廢 | 由營業單位使用調整作業處理 |
| 3 | 請按F10確認執行作廢處理 | 按F10確認進行作廢處理 |
| 4 | 作廢調整單已建立 | 顯示新建立的作廢調整單號碼 |
| 5 | 調整單已開立發票，無法作廢 | 請先作廢對應發票後再作廢調整單 |
| 6 | 調整單已作廢，不可重複作廢 | 該調整單已被作廢，無需重複處理 |

## 8. 維護紀錄
此程式有多次修改更新，主要包含：
- 89/02/18：初版建立（S02YSH）
- 92/06/10：調整單作廢時調整單編號一併作廢
- 99/08/20：修改程式結構（2010AR517）
- 104/09/18：新增產品代碼3及5類處理（2015AR953） 