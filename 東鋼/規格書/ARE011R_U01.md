# ARE011R_U01 程式規格書

## 1. 基本資料

| 項目 | 內容 |
|------|------|
| **程式編號** | ARE011R |
| **程式名稱** | 下載處理作業 |
| **程式類型** | RPG |
| **廠區** | U01 |
| **系統名稱** | 應收帳款系統 |
| **子系統** | 收款下載子系統 |
| **檔案位置** | 東鋼list/ARE011R_U01.txt |

## 2. 🎯 程式功能說明

### 主要功能描述
ARE011R為下載處理作業程式，專門處理收款資料的查詢、下載和狀態管理功能。程式提供日期範圍查詢機制，載入符合條件的收款明細資料，並支援批次下載處理和狀態更新功能。

### 🎯 業務流程詳細說明

#### 完整業務流程圖
```mermaid
flowchart TD
    A[程式啟動] --> B[畫面1: 日期條件輸入]
    B --> C[輸入收款日期範圍]
    C --> D[CK#01日期檢核]
    D --> E{檢核結果}
    
    E -->|有錯誤| F[顯示錯誤訊息]
    E -->|無錯誤| G[PR#02載入收款明細]
    
    G --> H[篩選符合條件資料]
    H --> I[畫面2: 明細顯示]
    I --> J[子檔顯示收款明細]
    
    J --> K{使用者操作}
    K -->|標記下載| L[CK#02明細檢核]
    K -->|CF03| M[程式結束]
    K -->|CF12| N[返回主畫面]
    
    L --> O{檢核結果}
    O -->|有錯誤| P[顯示錯誤訊息]
    O -->|無錯誤| Q[FL#02檔案處理]
    
    Q --> R[更新下載狀態]
    R --> S[更新處理日期]
    S --> T[重新載入畫面]
    
    F --> B
    P --> J
    T --> J
    N --> B
```

#### 業務流程關鍵階段說明

**階段1: 查詢條件設定階段**
- 輸入收款日期起始和結束範圍
- 驗證日期格式和邏輯正確性
- 檢查起始日期不能大於結束日期
- 調用UTS102R進行日期格式驗證

**階段2: 資料載入篩選階段**
- 使用日期範圍查詢RCVDTLL1收款明細檔
- 篩選廠區權限相符的收款記錄
- 排除已標記刪除或無效的記錄
- 整合銀行帳戶資料和票據資訊

**階段3: 明細顯示處理階段**
- 載入符合條件的收款明細到SF1子檔
- 顯示銀行帳戶、票據、金額等完整資訊
- 提供下載狀態的視覺化顯示
- 支援分頁瀏覽和記錄定位功能

**階段4: 下載處理執行階段**
- 檢核使用者選擇的下載項目
- 驗證銀行帳戶的有效性
- 更新收款記錄的下載標記
- 記錄下載處理的日期和時間

#### 資料篩選機制
- **日期篩選**: 根據收款日期範圍進行精確篩選
- **廠區篩選**: 僅顯示當前廠區權限的收款記錄
- **狀態篩選**: 排除已刪除或無效的記錄
- **票據篩選**: 僅處理有票據號碼的記錄
- **IFRS篩選**: 根據IFRS會計準則調整查詢邏輯

#### 下載狀態管理
- **未下載**: 新建立的收款記錄，可進行下載
- **已下載**: 標記為'Y'的記錄，顯示下載日期
- **已取消**: 標記為'C'的記錄，清除下載資訊
- **狀態切換**: 支援下載狀態的動態切換

## 3. 🎯 檔案架構與關聯圖

### 使用檔案清單

| 檔案名稱 | 檔案用途 | 存取方式 | 關聯鍵值 |
|----------|---------|---------|----------|
| **ARE011S** | 顯示檔案 | WORKSTN | - |
| **RCVDTLL1** | 收款明細檔L1 | UF | RVDATE+RVNTNO+RVNO+RVITEM |
| **BANKAC** | 銀行帳戶檔 | IF | ACTYPE+ACCURR+ACACNO |

### 🎯 檔案關聯詳細視覺化圖表

```mermaid
graph TD
    A[RCVDTLL1<br/>收款明細檔L1] --> B[ARE011R<br/>主程式]
    C[BANKAC<br/>銀行帳戶檔] --> B
    
    B --> D[RCVDTLL1<br/>下載狀態更新]
    
    subgraph "查詢處理流程"
        E[日期範圍輸入] --> B
        B --> F[收款明細篩選]
        B --> G[銀行帳戶驗證]
        B --> H[票據資料整合]
    end
    
    subgraph "下載處理流程"
        B --> I[下載標記處理]
        B --> J[狀態更新處理]
        B --> K[處理日期記錄]
    end
    
    subgraph "顯示控制"
        B --> L[ARE011S顯示檔案]
        L --> M[主畫面日期輸入]
        L --> N[明細子檔顯示]
    end
```

### 🎯 資料流向詳細說明

#### 查詢階段的資料流向
```mermaid
sequenceDiagram
    participant U as 使用者
    participant S as ARE011S畫面
    participant P as ARE011R程式
    participant R as RCVDTLL1檔案
    participant B as BANKAC檔案
    
    U->>S: 輸入日期範圍
    S->>P: 傳送查詢條件
    P->>P: 執行CK#01日期檢核
    P->>R: 讀取收款明細資料
    R-->>P: 回傳收款記錄
    P->>B: 查詢銀行帳戶資訊
    B-->>P: 回傳銀行資料
    P->>S: 載入SF1子檔
    S-->>U: 顯示查詢結果
```

#### 下載處理階段的資料流向
```mermaid
sequenceDiagram
    participant U as 使用者
    participant S as SF1子檔
    participant P as ARE011R程式
    participant R as RCVDTLL1檔案
    
    U->>S: 標記下載項目
    S->>P: 傳送下載選擇
    P->>P: 執行CK#02明細檢核
    
    loop 處理選擇項目
        P->>R: 讀取收款記錄
        R-->>P: 回傳記錄資料
        
        alt 標記下載
            P->>R: 設定RVPRCD='Y'
            P->>R: 更新RVPRDT下載日期
        else 取消下載
            P->>R: 清除下載標記
            P->>R: 清除下載日期
        end
        
        P->>R: 更新異動資訊
    end
    
    P->>S: 重新載入子檔
    S-->>U: 顯示更新結果
```

#### 狀態管理的資料流向
```mermaid
sequenceDiagram
    participant P as ARE011R程式
    participant R as RCVDTLL1檔案
    participant S as 系統控制
    
    P->>R: 檢查收款記錄狀態
    R-->>P: 回傳目前狀態
    
    alt 執行下載
        P->>R: RVPRCD設為'Y'
        P->>R: RVPRDT設為系統日期
        P->>R: RVFLAG設為'C'
        P->>R: 更新異動日期RVTXDT
    else 取消下載
        P->>R: RVPRCD清除
        P->>R: RVPRDT清除
        P->>R: 保持其他狀態
    end
    
    P->>S: 記錄處理日誌
    P->>P: 更新畫面顯示
```

## 4. 🎯 檔案欄位規格說明

### 主要資料結構

#### RCVDTLL1 收款明細檔L1記錄結構
```
RVREC (收款記錄)
├── RVDATE (收款日期, 8位)
├── RVNTNO (票據號碼, 20位)
├── RVNO (收款編號, 6位)
├── RVITEM (收款項次, 2位)
├── RVACNO (收款帳號, 9位)
├── RVNTCD (票據代碼, 1位)
├── RVVNO2 (票據編號2, 20位)
├── RVTBID (轉入銀行, 6位)
├── RVTANO (轉入帳號, 10位)
├── RVNTTP (票據性質, 1位)
├── RVDUDT (票據到期日, 8位)
├── RVRAMT (收款金額, 10位)
├── RVPRCD (處理代碼, 1位)
├── RVPRDT (處理日期, 8位)
├── RVPBID (付款銀行, 6位)
├── RVPANO (付款帳號, 10位)
├── RVCUNM (客戶名稱, 10位)
├── RVPLAC (票據發票地, 1位)
├── RVUSTP (收款性質, 1位)
├── RVFLAG (處理旗標, 1位)
├── RVTXAR (異動廠區, 1位)
└── RVTXDT (異動日期, 8位)
```

#### BANKAC 銀行帳戶檔記錄結構
```
ACREC (帳戶記錄)
├── ACTYPE (帳戶類型, 1位)
├── ACCURR (帳戶幣別, 1位)
├── ACACNO (帳戶號碼, 8位)
├── ACBAID (銀行識別, 6位)
└── ACBNAM (銀行名稱, 10位)
```

### 🔍 重點欄位切割技術詳解

#### DS結構完整分析

**AADS資料結構分析**
```
AADS (28位元結構)：[YYYYYYYY|DDDDDDDD|DDDDDDDD|DDDD]
位置範圍:            021-028   001-008   009-016  017-020
結構用途:            年月日    年月日    年月日    其他
```

#### 欄位切割視覺化展示
```
YMD (8字元)：[YYYYMMDD]
位置021-028： 完整日期欄位
├── 位置021-024: YY = 年度(4位)
├── 位置025-026: MM = 月份(2位)
└── 位置027-028: DD = 日期(2位)
```

**BBDS帳戶結構分析**
```
BBDS (10位元結構)：[T|C|AAAAAAAA]
位置範圍:            11 12 13-20
結構用途:            類型|幣別|帳號
```

#### 切割邏輯詳細說明

**日期欄位組合邏輯**
- YMD為完整的8位數日期格式
- YY為年度部分，支援4位年度格式
- MM為月份部分，範圍01-12
- DD為日期部分，範圍01-31
- 支援系統日期的自動設定和驗證

**帳戶結構切割邏輯**
- W02包含完整的帳戶識別資訊
- ACTYPE為帳戶類型碼(1位)
- ACCURR為帳戶幣別碼(1位)
- ACACNO為實際帳戶號碼(8位)
- 透過BANKAC檔案取得銀行詳細資訊

#### 實際數據範例說明
```
原始日期: 20241226
切割結果:
├── YMD = "20241226" (完整日期)
├── YY = "2024" (2024年)
├── MM = "12" (12月)
└── DD = "26" (26日)

原始帳戶: "A1234567890"
切割結果:
├── ACTYPE = "A" (帳戶類型)
├── ACCURR = "1" (帳戶幣別)
└── ACACNO = "234567890" (帳戶號碼)
```

### 重要變數定義表

| 變數名稱 | 資料型態 | 長度 | 用途說明 |
|----------|---------|------|----------|
| **DATE1** | 數值 | 8 | 收款日期起 |
| **DATE2** | 數值 | 8 | 收款日期止 |
| **DATE0** | 數值 | 8 | 下載處理日期 |
| **SCRN** | 字元 | 1 | 畫面控制變數 |
| **RRN** | 數值 | 3 | 子檔記錄序號 |
| **R#L01** | 數值 | 3 | 顯示記錄限制(990) |
| **DSPREC** | 數值 | 4 | 顯示記錄號 |
| **ACT** | 字元 | 1 | 處理動作標記 |
| **W01** | 字元 | 6 | 轉入銀行代碼 |
| **W01X** | 字元 | 10 | 銀行名稱 |
| **W02** | 字元 | 10 | 轉入帳號 |
| **W03** | 字元 | 20 | 票據號碼 |
| **W04** | 字元 | 10 | 票據性質說明 |
| **W05** | 數值 | 8 | 票據到期日 |
| **W06** | 數值 | 10 | 收款金額 |
| **W07** | 字元 | 1 | 處理代碼 |
| **W21** | 字元 | 6 | 付款銀行 |
| **W22** | 字元 | 10 | 付款帳號 |
| **W23** | 字元 | 6 | 收款編號 |
| **W24** | 字元 | 10 | 客戶名稱 |
| **W25** | 數值 | 8 | 收款日期 |
| **W26** | 字元 | 6 | 票據發票地說明 |
| **W27** | 字元 | 1 | 收款性質 |
| **H01-H04** | 字元 | 各異 | 原始值保存變數 |

## 5. 🎯 輸出/入螢幕布局

### 螢幕布局完整視覺化

#### ARE011S-1 日期條件輸入畫面
```
+----------------------------------------------------------+
|  2024/12/26        ***  下載處理作業  ***        ARE011S-1|
|                                                    U01DEV|
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                   收款日期起: [2024/12/01]               |
|                                                          |
|                   　　　　止: [2024/12/26]               |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
|                                                          |
| [錯誤訊息顯示區]                                         |
| ENTER:執行         PF03:離開                            |
+----------------------------------------------------------+
```

#### ARE011S-2 收款明細顯示畫面
```
+----------------------------------------------------------+
|  2024/12/26        ***  下載處理作業  ***        ARE011S-2|
|                                                    U01DEV|
|                                                          |
| 下載日期: [2024/12/26] 收款日期: [2024/12/01]-[2024/12/26]|
| 處理代號：Y:下載 C:取消                                  |
|----------------------------------------------------------+
| 處                                                       |
| 理   下             銀行名稱   票據號碼      收款編號   下|
| 代   載             　　　　   　　　　      　　　　   載|
| 號   銀行帳號       　　　　   票據性質     到期日 收款金額|
|----------------------------------------------------------+
| [Y] [1234567890] [中國信託銀行] [TK20241201001] [RV001] [Y]|
|     [9876543210] [台灣銀行    ] [支票        ] [12/31] [100,000.00]|
| [Y] [2345678901] [台北富邦銀行] [TK20241202002] [RV002] [Y]|
|     [8765432109] [第一銀行    ] [本票支票    ] [01/15] [250,000.00]|
| [ ] [3456789012] [國泰世華銀行] [TK20241203003] [RV003] [ ]|
|     [7654321098] [華南銀行    ] [現金        ] [    ] [150,000.00]|
|----------------------------------------------------------+
| [錯誤訊息顯示區]                                         |
| ENTER:確認   PF03:離開   PF10:存檔   PF12:返回上層     |
+----------------------------------------------------------+
```

### 🎯 畫面欄位詳細說明

#### 主畫面欄位
| 欄位名稱 | 屬性 | 長度 | 輸入格式 | 驗證規則 |
|----------|------|------|----------|----------|
| **DATE1** | 必填 | 8 | 日期 | YYYY/MM/DD格式 |
| **DATE2** | 必填 | 8 | 日期 | YYYY/MM/DD格式 |

#### 明細畫面欄位
| 欄位名稱 | 屬性 | 長度 | 輸入格式 | 驗證規則 |
|----------|------|------|----------|----------|
| **DATE0** | 唯讀 | 8 | 日期 | 系統自動設定 |
| **ACT** | 修改 | 1 | Y/C/空白 | 處理代碼驗證 |
| **W02** | 修改 | 10 | 英數字 | 銀行帳號格式 |
| **W01X** | 唯讀 | 10 | 顯示用 | 銀行名稱 |
| **W03** | 唯讀 | 20 | 顯示用 | 票據號碼 |
| **W04** | 唯讀 | 10 | 顯示用 | 票據性質說明 |
| **W05** | 唯讀 | 8 | 日期 | 票據到期日 |
| **W06** | 唯讀 | 10 | 數值 | 收款金額 |
| **W07** | 唯讀 | 1 | 顯示用 | 處理代碼 |

### 🎯 畫面控制邏輯

#### 指示器控制說明
| 指示器 | 控制項目 | 狀態說明 |
|--------|---------|----------|
| **IN40** | DATE0欄位 | PC+RI (錯誤閃爍反白) |
| **IN41** | DATE1欄位 | PC+RI (錯誤閃爍反白) |
| **IN42** | DATE2欄位 | PC+RI (錯誤閃爍反白) |
| **IN43** | W02欄位 | PC+RI (錯誤閃爍反白) |
| **IN51** | 子檔保護 | PR (保護模式啟用) |
| **IN77** | IFRS控制 | IFRS會計準則控制 |
| **IN80** | 子檔清除 | SFLCLR (清除子檔內容) |
| **IN88** | 子檔異動 | SFLNXTCHG (標記異動) |

### 功能鍵詳細定義

#### 主畫面功能鍵
| 功能鍵 | 處理邏輯 | 系統行為 |
|--------|---------|----------|
| **ENTER** | 執行查詢 | 根據日期範圍載入明細 |
| **CF03** | 離開程式 | 設定*IN03='1'結束程式 |

#### 明細畫面功能鍵
| 功能鍵 | 處理邏輯 | 系統行為 |
|--------|---------|----------|
| **ENTER** | 確認操作 | 執行明細檢核和處理 |
| **CF03** | 離開 | 返回功能選擇畫面 |
| **CF10** | 存檔 | 執行FL#02檔案更新 |
| **CF12** | 返回 | 返回日期輸入畫面 |

## 6. 🎯 處理流程程序說明

### 🎯 主程序邏輯深度分析

#### 程式執行流程圖
```mermaid
flowchart TD
    A[程式開始] --> B[系統初始化]
    B --> C[IFRS會計準則檢查]
    C --> D[設定初始變數]
    D --> E[主迴圈開始]
    
    E --> F{SCRN畫面判斷}
    F -->|SCRN='1'| G[SR#01 主畫面處理]
    F -->|SCRN='2'| H[SR#02 明細處理]
    
    G --> I[EXFMT TITLE]
    I --> J[KC#01 中斷檢查]
    J --> K{是否中斷}
    K -->|是| L[程式結束]
    K -->|否| M[CK#01 日期檢核]
    
    M --> N{檢核結果}
    N -->|有錯誤| O[顯示錯誤訊息]
    N -->|無錯誤| P[PR#02 載入明細]
    P --> Q[切換到明細畫面]
    
    H --> R[EXFMT SFCTL1]
    R --> S[KC#01 中斷檢查]
    S --> T{使用者操作}
    
    T -->|CF10| U[KJ#02 存檔處理]
    T -->|CF12| V[KL#02 返回處理]
    T -->|ENTER| W[CK#02 明細檢核]
    
    U --> X[CK#02 明細檢核]
    X --> Y[FL#02 檔案處理]
    Y --> Z[切換到主畫面]
    
    V --> AA[清除錯誤訊息]
    AA --> Z
    
    W --> BB[執行明細檢核]
    BB --> H
    
    O --> G
    Q --> E
    Z --> E
    
    E --> CC{*IN03是否為1}
    CC -->|是| L
    CC -->|否| F
```

#### 🎯 詳細處理步驟逐一分析

**步驟1: 系統環境初始化**
- 計算系統日期並設定到U#SYSD變數
- 檢查IFRS會計準則實施狀態
- 初始化日期變數DATE0, DATE1, DATE2
- 設定顯示記錄限制R#L01=990
- 設定初始畫面SCRN='1'

**步驟2: 主畫面輸入處理(SR#01)**
- 顯示TITLE日期輸入畫面
- 檢查中斷鍵(CF03)的按下狀況
- 執行CK#01進行日期檢核
- 根據檢核結果決定後續處理

**步驟3: 明細畫面處理(SR#02)**
- 執行PR#02載入收款明細資料
- 顯示SFCTL1子檔控制畫面
- 處理使用者的各種操作指令
- 根據功能鍵執行對應處理

**步驟4: 檔案更新執行(FL#02)**
- 掃描子檔中的異動記錄
- 更新收款記錄的處理狀態
- 設定或清除下載標記
- 記錄處理日期和異動資訊

#### 業務邏輯深度解析

**日期檢核機制**
```
日期檢核邏輯(CK#01):
1. 檢查DATE1起始日期不大於DATE2結束日期
2. 調用UTS102R驗證DATE1日期格式
3. 調用UTS102R驗證DATE2日期格式
4. 設定對應的錯誤指示器和訊息
```

**資料載入機制**
```
資料載入邏輯(PR#02):
1. 清除SF1子檔並重置計數器
2. 使用RVKEY複合鍵讀取RCVDTLL1檔案
3. 依據日期範圍和廠區權限篩選資料
4. 整合銀行帳戶和票據資訊
5. 載入到子檔供畫面顯示
```

**下載處理機制**
```
下載處理邏輯(FL#02):
1. 掃描子檔中的處理標記
2. 根據ACT處理代碼執行對應動作
3. Y:設定下載標記和日期
4. C:清除下載標記和相關資訊
5. 更新檔案異動資訊
```

#### 條件判斷詳細說明

**廠區權限判斷**
- 檢查收款記錄的廠區代碼
- P廠區記錄需額外檢查編號前綴
- 排除非當前廠區權限的記錄
- 確保資料安全和存取控制

**票據資料判斷**
- 檢查票據號碼(RVNTNO)非空白
- 檢查票據代碼(RVNTCD)非空白
- 檢查票據編號2(RVVNO2)非空白
- 只處理完整票據資料的記錄

**IFRS會計準則判斷**
- 根據系統日期和IFRS實施日期比較
- 調整帳戶代碼的檢查邏輯
- 1131或111001帳戶的特殊處理

#### 變數使用和數據流向

**關鍵變數生命週期**
```
DATE1/DATE2 (日期範圍):
輸入 → 格式檢查 → 邏輯驗證 → 查詢條件 → 資料篩選

RRN (記錄號):
初始化 → 逐筆遞增 → 子檔定位 → 資料處理

ACT (處理代碼):
輸入 → 格式檢查 → 處理分派 → 檔案更新

W01-W27 (顯示變數):
資料載入 → 格式轉換 → 畫面顯示 → 使用者檢視
```

### 🎯 子程序邏輯分析

#### KC#01 中斷檢查子程序
**功能**: 檢查使用者是否按下CF03中斷鍵
**參數**: 無
**處理邏輯**: 設定LR指示器並返回程式

#### CK#01 日期檢核子程序
**功能**: 驗證日期輸入的正確性
**檢核項目**:
- 起始日期不能大於結束日期
- 日期格式驗證(調用UTS102R)
- 日期邏輯合理性檢查
- 設定對應的錯誤指示器

#### PR#02 資料準備子程序
**功能**: 載入符合條件的收款明細資料
**處理步驟**:
1. 清除子檔和重置變數
2. 設定查詢起始位置
3. 循環讀取收款明細檔
4. 篩選符合條件的記錄
5. 整合銀行和票據資訊
6. 寫入子檔供顯示

#### CK#02 明細檢核子程序
**功能**: 檢核明細畫面的使用者輸入
**檢核項目**:
- 銀行帳戶的存在性驗證
- 處理代碼的有效性檢查
- 下載狀態的邏輯檢查

#### FL#02 檔案處理子程序
**功能**: 執行收款明細的狀態更新
**處理步驟**:
1. 掃描子檔中的異動記錄
2. 讀取對應的收款明細記錄
3. 根據處理代碼更新狀態
4. 設定或清除下載標記
5. 更新處理日期和異動資訊

### 🎯 特殊邏輯處理

#### IFRS會計準則控制
**IFRS處理邏輯**:
- 比較系統日期與IFRS實施日期
- 根據IFRS狀態調整帳戶代碼檢查
- 影響收款帳號的驗證邏輯
- 控制特定功能的啟用狀態

#### 票據性質處理
**票據類型轉換**:
```
票據性質對應:
A: 支票
B: 本票支票  
C: 現金
D: 本票匯票
E: 銀行匯票
I: 信用狀
其他: 顯示"其他"
```

#### 銀行帳戶整合
**帳戶資訊處理**:
```
帳戶處理邏輯:
1. 組合ACTYPE+ACCURR+ACACNO查詢鍵值
2. 查詢BANKAC銀行帳戶檔
3. 取得銀行識別碼ACBAID
4. 取得銀行名稱ACBNAM
5. 顯示完整的銀行資訊
```

## 7. 🎯 錯誤處理程序說明

### 🎯 詳細錯誤代碼清冊

| 錯誤代碼 | 錯誤訊息 | 原因說明 | 處理方式 | 預防措施 |
|----------|---------|---------|---------|----------|
| **ERR001** | 日期錯誤 | 日期格式不正確或日期無效 | 1. 檢查日期格式<br>2. 使用YYYY/MM/DD格式<br>3. 確認日期有效性 | 日期格式驗證和範圍檢查 |
| **ERR002** | 查詢日期錯誤 | 起始日期大於結束日期 | 1. 調整日期範圍<br>2. 確認邏輯正確性<br>3. 重新輸入日期 | 日期邏輯驗證機制 |
| **ERR003** | 無符合條件資料 | 指定日期範圍內無收款記錄 | 1. 擴大日期範圍<br>2. 確認資料存在性<br>3. 檢查權限設定 | 資料存在性提示 |
| **ERR004** | 處理代號錯誤 | 處理代碼不在有效範圍內 | 1. 使用Y或C代碼<br>2. 檢查輸入格式<br>3. 確認操作意圖 | 處理代碼VALUES限制 |
| **ERR005** | 銀行代號錯誤 | 銀行代碼不存在或無效 | 1. 檢查銀行代碼<br>2. 確認銀行檔案<br>3. 使用有效代碼 | 銀行代碼驗證 |
| **ERR006** | 銀行帳號錯誤 | 銀行帳號格式錯誤或不存在 | 1. 檢查帳號格式<br>2. 確認帳號存在性<br>3. 驗證帳號狀態 | 銀行帳號完整性檢查 |
| **ERR007** | 系統資料已下載無法再下載 | 記錄已標記為下載狀態 | 1. 確認下載狀態<br>2. 檢查處理代碼<br>3. 先取消再重新下載 | 下載狀態管理 |
| **ERR008** | 系統資料未下載無法匯入 | 嘗試取消未下載的記錄 | 1. 確認記錄狀態<br>2. 檢查處理歷程<br>3. 確認操作邏輯 | 狀態邏輯檢查 |

### 🎯 系統異常處理邏輯

#### 檔案操作失敗處理
**RCVDTLL1檔案操作異常**:
```
讀取失敗: 設定IN97指示器 → 跳過該記錄 → 繼續處理
更新失敗: 記錄錯誤資訊 → 回復異動 → 顯示錯誤
鎖定失敗: 等待解鎖 → 重新嘗試 → 記錄日誌
```

**BANKAC檔案操作異常**:
```
查詢失敗: 設定IN31指示器 → 清除銀行資訊 → 繼續顯示
連線異常: 重新連接檔案 → 檢查網路狀態 → 錯誤回報
```

#### 子檔案處理錯誤
**SF1子檔案錯誤**:
```
子檔案滿: 檢查記錄數限制(990筆) → 分批處理 → 提示使用者
資料不一致: 重新載入子檔案 → 確認資料完整性
顯示錯誤: 重設畫面狀態 → 重新顯示資料
```

#### 日期處理錯誤
**日期格式和邏輯錯誤**:
```
格式錯誤: 調用UTS102R驗證 → 顯示格式要求 → 重新輸入
邏輯錯誤: 檢查日期範圍 → 提供合理建議 → 修正輸入
系統日期異常: 使用預設日期 → 記錄異常狀況 → 繼續處理
```

#### 權限和廠區錯誤處理
**廠區權限錯誤**:
```
權限不足: 檢查使用者廠區 → 篩選可存取資料 → 提示限制
資料歸屬錯誤: 驗證資料廠區 → 排除非權限資料 → 繼續處理
跨廠區存取: 檢查特殊權限 → 記錄存取日誌 → 控制功能
```

#### IFRS會計準則錯誤處理
**IFRS控制錯誤**:
```
日期判斷錯誤: 重新檢查系統日期 → 確認IFRS設定 → 修正邏輯
帳戶代碼錯誤: 根據IFRS狀態調整 → 提供正確代碼 → 重新處理
功能限制: 檢查IFRS功能權限 → 提示使用者 → 引導正確操作
```

## 8. 🎯 備註

### 🎯 特殊注意事項

**下載作業特性**:
- 程式專門處理收款資料的下載和狀態管理
- 支援批次下載處理和狀態追蹤機制
- 提供完整的票據資訊整合和顯示
- 整合銀行帳戶驗證和資訊查詢功能

**日期範圍查詢機制**:
- 支援精確的日期範圍篩選功能
- 提供完整的日期格式驗證機制
- 整合UTS102R日期驗證程式
- 確保查詢效率和資料準確性

**IFRS會計準則整合**:
- 檢查系統日期與IFRS實施日期
- 根據IFRS狀態調整帳戶代碼邏輯
- 影響收款帳號的驗證和顯示
- 確保會計準則的一致性

**廠區權限控制**:
- 嚴格控制使用者存取權限
- P廠區記錄需要特殊的編號檢查
- 確保資料安全和隱私保護
- 支援跨廠區資料的有限存取

**票據資料整合**:
- 完整的票據性質分類和說明
- 支援六種主要票據類型(A-E和I)
- 整合票據號碼、到期日、金額資訊
- 提供票據發票地的視覺化顯示

**下載狀態管理邏輯**:
- Y標記: 已下載狀態，記錄下載日期
- C標記: 取消下載，清除相關資訊
- 空白: 未處理狀態，可進行下載
- 防止重複下載的控制機制

**銀行帳戶整合機制**:
- 透過BANKAC檔案取得完整銀行資訊
- 支援銀行代碼和帳號的組合驗證
- 提供銀行名稱的友善顯示
- 確保帳戶資訊的準確性和一致性

**顯示記錄限制控制**:
- 最多顯示990筆收款記錄
- 防止系統資源過度消耗
- 提供分批查詢的建議機制
- 確保程式執行的穩定性 