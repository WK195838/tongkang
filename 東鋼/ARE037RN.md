# ARE037RN 程式功能規格書

## 1. 基本資料
- **程式名稱**：ARE037RN
- **程式說明**：應收帳款請求單輸入作業（原始與清算）
- **程式語言**：RPG/400
- **程式位置**：東鋼/10.10.40.100/QRPGSRC_ARLIB/ARE037RN.txt
- **開發人員**：S02YSH（原始）、S00WCJ（多次修改）
- **系統名稱**：應收帳款系統
- **子系統**：請求單處理
- **開發日期**：91/05/08
- **備註**：此程式供外購與內製輸入請求資料到SARCVF，可進行修改、刪除等操作

## 2. 檔案架構與關聯圖
### 使用檔案：
- **資料庫檔案**
  - SARCVF：請求單主檔
  - SARCVFL5：請求單相關檔
  - SARVIN：請求單明細檔
  - SARVOR：訂單相關檔案
  - SARVORL1/SARVORL2/SARVORL3：訂單相關子檔
  - TRNDTL：交易明細檔
  - TRNDTLL4：交易明細子檔
  - TREXPTL1：交易記錄子檔
  - CBCUST：客戶基本資料檔
  - HSCINVL3：相關單據檔
  - GENSEQ：流水號檔
  - HSMAST：料件基本資料檔

### 檔案關聯圖視覺化：

```
+-------------+      +------------+      +------------+
|   SARCVF    |<---->|  ARE037RN  |<---->|   SARVIN   |
| (請求單主檔) |      | (請求單輸入 |      | (請求單明細)|
+-------------+      |    作業)   |      +------------+
       ^             +------------+             ^
       |                   ^                    |
       v                   |                    v
+-------------+            |            +------------+
| SARCVFL5    |            |            |   SARVOR   |
| (請求單相關檔)|            |            | (訂單相關檔)|
+-------------+            |            +------------+
                           |                   |
        +------------------+------------------+|
        |                  |                  ||
        v                  v                  vv
+-------------+   +----------------+   +----------------+
|   TRNDTL    |   |    CBCUST     |   | SARVORL1/2/3   |
| (交易明細檔) |   | (客戶基本檔)  |   | (訂單相關子檔) |
+-------------+   +----------------+   +----------------+
        ^
        |
        v
+-------------+
|  TRNDTLL4   |
|(交易明細子檔)|
+-------------+
```

## 3. 檔案欄位規格說明

### 資料結構定義區（欄位切割/借用區域）
| 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|---------|------|------|------|------|
| SRRVNO | 1-6 | 6 | 字元 | 請求單號，被切割儲存其他資料 |
| D#RVNO | 1 | 1 | 字元 | 切割自SRRVNO的第1位元作為請求單號類型 |
| D#RVNX | 1-6 | 6 | 字元 | 請求單號，被切割儲存其他資料 |
| D#RVN1 | 1 | 1 | 字元 | 切割自D#RVNX的第1位元作為請求類型代碼 |
| D#RVN2 | 2-6 | 5 | 字元 | 切割自D#RVNX的第2-6位元作為請求單號主體 |
| D#ARY | 1-30 | 30 | 字元 | 科目類別資料，被切割儲存多個資訊 |
| D#ACTP | 1 | 1 | 字元 | 切割自D#ARY的第1位元作為科目類型 |
| D#ACNO | 2-7 | 6 | 字元 | 切割自D#ARY的第2-7位元作為科目編號 |
| D#RAMT | 8-19 | 12 | 數值 | 切割自D#ARY的第8-19位元作為金額 |
| D#EXC2 | 20-27 | 8 | 數值 | 切割自D#ARY的第20-27位元作為交換值 |
| D#CURY | 28-30 | 3 | 字元 | 切割自D#ARY的第28-30位元作為幣別 |
| TXORNO | 1-9 | 9 | 字元 | 訂單編號，被切割儲存其他資料 |
| D#ORNO | 1-6 | 6 | 字元 | 切割自TXORNO的第1-6位元作為訂單編號 |
| D#OITM | 7-9 | 3 | 字元 | 切割自TXORNO的第7-9位元作為項次 |
| W#OEOF | 1-2 | 2 | 字元 | 控制旗標區，切割為兩個旗標 |
| D#OE | 1 | 1 | 字元 | 切割自W#OEOF的第1位元作為旗標1 |
| D#OF | 2 | 1 | 字元 | 切割自W#OEOF的第2位元作為旗標2 |
| TXNO | 1-8 | 8 | 字元 | 交易號碼，被切割利用 |
| D#AREA | 1 | 1 | 字元 | 切割自TXNO的第1位元作為區域碼 |
| W1ORNO | 1-6 | 6 | 字元 | 訂單資料，被切割利用 |
| S1OREA | 1 | 1 | 字元 | 切割自W1ORNO的第1位元作為區域碼 |
| S1ORNO | 2-6 | 5 | 字元 | 切割自W1ORNO的第2-6位元作為訂單編號 |
| D#CUNO | 1-6 | 6 | 字元 | 客戶編號，被切割為多個部分 |
| S1KIND | 1 | 1 | 字元 | 切割自D#CUNO的第1位元作為客戶類型 |
| S1CUN1 | 2 | 1 | 字元 | 切割自D#CUNO的第2位元作為客戶代碼1 |
| S1CUN2 | 3-5 | 3 | 字元 | 切割自D#CUNO的第3-5位元作為客戶代碼2 |
| S1CUN3 | 6 | 1 | 字元 | 切割自D#CUNO的第6位元作為客戶代碼3 |
| D#IFRS | 1-8 | 8 | 字元 | IFRS相關資料區 |

### 欄位切割視覺化 (科目類別切割範例)：

```
D#ARY (30字元)：[X|XXXXXX|XXXXXXXXXXXX|XXXXXXXX|XXX]
                 ↓    ↓        ↓         ↓      ↓ 
D#ACTP (1字元)：[X]                             科目類型
D#ACNO (6字元)：  [XXXXXX]                      科目編號
D#RAMT (12字元)：          [XXXXXXXXXXXX]       金額
D#EXC2 (8字元)：                      [XXXXXXXX]交換值
D#CURY (3字元)：                               [XXX]幣別
```

### 程式使用的主要欄位
| 欄位名稱 | 說明 | 資料類型 | 備註 |
|---------|---------|---------|------|
| SRCUNO | 客戶編號 | 字元 | 請求單主檔客戶編號 |
| SRRVDT | 請求日期 | 數值 | 請求單主檔日期 |
| SRRVNO | 請求單號 | 字元 | 請求單主檔編號 |
| SRITEM | 項次 | 數值 | 請求單主檔項次 |
| W1RVNO | 請求單號 | 字元 | 處理用請求單號 |
| W1STNO | 出貨單號 | 字元 | 處理用出貨單號 |
| W1NOXA | 標記 | 字元 | 處理用標記 |
| SOCODE | 代碼 | 字元 | 訂單代碼 |
| SOQTY | 數量 | 數值 | 訂單數量 |
| EXFLAG | 旗標 | 字元 | 交易旗標 |
| EXNO | 單號 | 字元 | 交易單號 |
| EXITEM | 項次 | 數值 | 交易項次 |
| EXCUNO | 客戶編號 | 字元 | 交易客戶編號 |
| EXORNO | 訂單編號 | 字元 | 交易訂單編號 |

## 4. 輸出/入螢幕布局與說明

### 請求單輸入作業畫面
程式提供多個操作畫面，用於：
1. 請求單資料輸入
2. 請求單修改
3. 請求單明細顯示
4. 請求單確認
5. 請求單刪除
6. 請求單查詢

### 畫面欄位說明
- 請求單號（顯示自動編號）
- 客戶編號及名稱
- 請求單日期
- 請求金額
- 付款方式
- 交易相關資訊

### 螢幕布局視覺化：

```
+----------------------------------------------------------+
|             應收帳款請求單輸入作業 (ARE037RN)             |
+----------------------------------------------------------+
| 功能: [ ] 新增 [ ] 修改 [ ] 查詢 [ ] 確認 [ ] 刪除       |
+----------------------------------------------------------+
| 請求單號: [         ]    狀態: [  ] 處理/未處理          |
| 客戶代號: [         ]    客戶名稱: [                   ] |
| 請求日期: [YYMMDD  ]    幣別: [   ]  匯率: [         ]  |
+----------------------------------------------------------+
| 科目類別       科目代號       科目說明       金額        |
| [  ]         [      ]      [          ]  [            ] |
| [  ]         [      ]      [          ]  [            ] |
| [  ]         [      ]      [          ]  [            ] |
+----------------------------------------------------------+
| 出貨單號       訂單編號       項次       數量     單價   |
| [        ]   [         ]    [   ]    [      ] [       ] |
| [        ]   [         ]    [   ]    [      ] [       ] |
| [        ]   [         ]    [   ]    [      ] [       ] |
+----------------------------------------------------------+
| 請求總額: [             ]    稅額: [             ]      |
| 備註: [                                               ] |
+----------------------------------------------------------+
| 功能鍵: F3=離開 F4=查詢 F5=重新整理 F10=確認 F13=明細   |
+----------------------------------------------------------+
```

## 5. 處理流程程序說明

### 主程序流程
1. 初始化系統環境與變數
2. 依據使用者角色設定不同的作業權限
3. 顯示主畫面並接收用戶選擇
4. 根據選擇執行不同的子程序
5. 完成資料處理後更新相關檔案

### 主要子程序
透過多個資料結構(DS)定義，將關鍵資料切割並存放到更小的欄位中：

1. **欄位切割技術應用**：
   - 將請求單號SRRVNO切割為D#RVNO（類型碼）和其他部分
   - 將科目類別D#ARY切割為D#ACTP（科目類型）、D#ACNO（科目編號）等多個欄位

2. **子程序功能說明**：
   - SR0000：初始化處理
   - SR1000：第一畫面處理
   - SR2000：第二畫面處理
   - SR3000：READC功能處理
   - SR4000：第三畫面處理
   - SR5000：第四畫面處理

## 6. 特殊欄位使用說明

### 欄位切割儲存技術
程式中使用了多個資料結構(DS)來進行欄位切割或借用，主要應用於：

1. **請求單號處理**：
   將請求單號切割為類型碼和單號主體
   ```
   DS
     1   6 SRRVNO
     1   1 D#RVNO
   DS
     1   6 D#RVNX
     1   1 D#RVN1
     2   6 D#RVN2
   ```

2. **科目類別處理**：
   將科目類別欄位切割為多個子欄位，方便處理不同屬性
   ```
   DS
     1  30 D#ARY
     1   1 D#ACTP
     2   7 D#ACNO
     8  19 D#RAMT
    20  27 D#EXC2
    28  30 D#CURY
   ```

3. **訂單編號處理**：
   將訂單編號切割為訂單號和項次
   ```
   DS
     1   9 TXORNO
     1   6 D#ORNO
     7   9 D#OITM
   ```

4. **旗標控制**：
   使用單一欄位的不同位置存放多個控制旗標
   ```
   DS
     1   2 W#OEOF
     1   1 D#OE
     2   2 D#OF
   ```

5. **客戶編號處理**：
   將客戶編號切割為多個部分，方便不同類型的客戶處理
   ```
   DS
     1   6 D#CUNO
     1   1 S1KIND
     2   2 S1CUN1
     3   5 S1CUN2
     6   6 S1CUN3
   ```

## 7. 錯誤處理程序說明與訊息清冊
程式中使用指示器(*IN)處理各種條件和錯誤：
- *IN99：錯誤處理指示器
- *IN73：畫面清除指示器
- *IN78：檢核結果指示器
- *IN85：特殊查詢模式指示器

錯誤訊息主要處理：
- 資料輸入格式錯誤
- 客戶編號不存在
- 項次重複
- 金額檢核錯誤
- 請求單已確認不可修改

## 8. 備註
1. 此程式使用了多種欄位切割和借用技術，對記憶體使用進行了優化。
2. 程式經過多次修改，添加了特殊客戶處理和額外的檢核功能。
3. 用戶權限控制使用特定的用戶ID（如H293、H837等）來設定。
4. 版本更新紀錄(如0109A、0205B等)清楚標示在程式註解中。
5. 程式中有特定會計科目處理邏輯，包括2159、7142等特殊科目。 